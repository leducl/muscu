<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym & Run Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary)',
                        'primary-hover': 'var(--primary-hover)',
                        'primary-light': 'var(--primary-light)',
                        'bg-body': 'var(--bg-body)',
                        'bg-card': 'var(--bg-card)',
                        'text-main': 'var(--text-main)',
                        'text-muted': 'var(--text-muted)'
                    }
                }
            }
        }
    </script>

    <style>
        /* --- VARIABLES CSS DYNAMIQUES (THEME) --- */
        :root {
            /* Couleurs par d√©faut (Bleu) - Seront √©cras√©es par le JS */
            --primary: #3b82f6;       
            --primary-hover: #2563eb;
            --primary-light: #60a5fa; 
            
            /* Fond par d√©faut (Slate) */
            --bg-body: #0f172a;       
            --bg-card: #1e293b;       
            
            /* Textes */
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
        }

        /* --- STYLES GLOBAUX --- */
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            padding-bottom: 130px; 
            transition: background-color 0.3s ease, color 0.3s ease; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .card { 
            background-color: var(--bg-card); 
            border-radius: 16px; 
            padding: 1.25rem; 
            margin-bottom: 1rem; 
            border: 1px solid rgba(255,255,255,0.05); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, border-color 0.3s; 
        }

        /* --- INPUTS & BOUTONS --- */
        .input-dark { 
            background-color: rgba(0,0,0,0.2); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: var(--text-main); 
            padding: 0.8rem; 
            border-radius: 12px; 
            width: 100%; 
            font-weight: 600; 
            transition: all 0.2s;
        }
        .input-dark:focus { 
            border-color: var(--primary); 
            outline: none; 
            background-color: rgba(0,0,0,0.4); 
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
            padding: 1rem; 
            border-radius: 14px; 
            font-weight: bold; 
            width: 100%; 
            text-align: center; 
            cursor: pointer; 
            box-shadow: 0 4px 15px -3px var(--primary); /* Lueur dynamique */
            transition: all 0.2s; 
        }
        .btn-primary:active { transform: scale(0.98); filter: brightness(0.9); }
        
        .btn-secondary { 
            background-color: rgba(255,255,255,0.05); 
            color: var(--text-main); 
            padding: 0.8rem; 
            border-radius: 12px; 
            cursor: pointer; 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            font-weight: 500; 
            transition: background 0.2s;
        }
        .btn-secondary:active { background-color: rgba(255,255,255,0.1); }
        
        /* --- ELEMENTS SPECIFIQUES --- */
        .nav-item.active { color: var(--primary-light); }
        .nav-item.active i { 
            transform: translateY(-2px); 
            color: var(--primary); 
            filter: drop-shadow(0 0 8px var(--primary)); /* Lueur icone */
        }
        
        .timer-btn { background-color: rgba(255,255,255, 0.05); border: 1px solid var(--primary); color: var(--primary-light); padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 700; }
        .timer-btn.active { background-color: #ea580c; border-color: #ea580c; color: white; animation: pulse 1.5s infinite; }
        
        /* Barres et Charts */
        .water-bar-bg { width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .water-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; box-shadow: 0 0 10px var(--primary); }
        .chart-bar { background: linear-gradient(to top, var(--primary), var(--primary-light)); border-radius: 4px 4px 0 0; position: relative; min-height: 4px; transition: height 0.5s ease; }

        /* --- NAVIGATION & MODALES --- */
        .navbar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(15, 23, 42, 0.85); border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-around; padding: 12px 0 24px 0; z-index: 50; backdrop-filter: blur(12px); }
        .nav-item { color: #64748b; text-align: center; flex: 1; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item i { width: 24px; height: 24px; transition: 0.2s; }
        .nav-item span { font-size: 10px; font-weight: 600; }

        .page-view { display: none; opacity: 0; animation: fadeIn 0.3s forwards; }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #calc-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .plate { display: inline-block; width: 45px; height: 45px; line-height: 41px; text-align: center; border-radius: 50%; font-weight: bold; font-size: 12px; margin: 3px; color: #1e293b; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .plate-20 { background-color: #2563eb; color: white; width: 55px; height: 55px; line-height: 51px; } 
        .plate-15 { background-color: #eab308; } .plate-10 { background-color: #16a34a; color: white; } 
        .plate-5 { background-color: #ef4444; color: white; width: 38px; height: 38px; line-height: 34px;} 
        .plate-2-5 { background-color: #1e293b; color: white; border-color: white; width: 32px; height: 32px; line-height: 28px; } 
        .plate-1-25 { background-color: #cbd5e1; width: 28px; height: 28px; line-height: 24px; font-size: 9px; }

        #toast { visibility: hidden; min-width: 250px; background-color: var(--primary); color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 60; left: 50%; bottom: 100px; transform: translateX(-50%); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.5); opacity: 0; transition: all 0.3s; font-weight: bold; }
        #toast.show { visibility: visible; opacity: 1; bottom: 110px; }
        #toast.error { background-color: #ef4444; }

        /* TOGGLE SWITCH */
        .toggle-checkbox:checked + .toggle-label { background-color: var(--primary); }
        .toggle-label { width: 44px; height: 24px; position: relative; display: block; background: #334155; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .toggle-label:after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: 0.3s; }
        .toggle-checkbox:checked + .toggle-label:after { transform: translateX(100%); }
        .toggle-checkbox { display: none; }
        
        /* UTILS */
        .clickable-history { cursor: pointer; border-radius: 6px; padding: 4px 8px; margin-right: 6px; display: inline-flex; align-items: center; gap: 4px; font-size: 0.7rem; border: 1px solid transparent; font-weight: 600; white-space: nowrap; }
        .clickable-history.last { background-color: rgba(255,255,255,0.05); color: var(--primary-light); border-color: var(--primary); }
        .clickable-history.coach { background-color: rgba(168, 85, 247, 0.15); color: #d8b4fe; border-color: rgba(168, 85, 247, 0.3); box-shadow: 0 0 10px rgba(168, 85, 247, 0.1); animation: glow 2s infinite alternate; }
        
        .meal-tag { font-size: 10px; text-transform: uppercase; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
        .tag-muscu { background-color: #1e3a8a; color: #93c5fd; } .tag-run { background-color: #451a03; color: #fbbf24; } .tag-rest { background-color: #064e3b; color: #6ee7b7; }
        .food-item { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; font-size: 11px; color: #cbd5e1; display: flex; align-items: center; gap: 6px; }
        
		select { 
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); 
            background-repeat: no-repeat; 
            background-position: right 1rem center; 
            background-size: 1rem auto; 
            padding-right: 2.5rem;
            
            /* --- C'EST CETTE LIGNE QUI CORRIGE LE BUG --- */
            color-scheme: dark; 
        }
            
        /* Force les couleurs des options (Backup pour certains navigateurs) */
        select option {
            background-color: #1e293b; /* Couleur sombre en dur (Slate-800) */
            color: white;
        }
		
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(234, 88, 12, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); } }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(168, 85, 247, 0.1); } to { box-shadow: 0 0 15px rgba(168, 85, 247, 0.3); } }
		

    </style>
</head>
<body class="p-4 max-w-md mx-auto">

    <header class="flex justify-between items-center mb-6 px-1">
        <div>
            <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-primary to-primary-light" id="header-title">Gym & Run</h1>
            <p class="text-[10px] text-text-muted font-bold tracking-widest uppercase" id="header-subtitle">Tracker hybride</p>
        </div>
        <div class="bg-card p-2 rounded-full border border-slate-700 shadow-lg">
            <i data-lucide="brain-circuit" class="w-5 h-5 text-purple-400"></i>
        </div>
    </header>

    <div id="view-tracker" class="page-view active">
        <div class="mb-6">
            <div class="relative">
                <select id="day-selector" onchange="manualDayChange(this.value)" class="w-full bg-card text-white border border-slate-600 rounded-xl p-3.5 font-bold focus:outline-none focus:border-primary shadow-lg appearance-none">
				</select>
            </div>
        </div>

        <div class="mb-4 px-1">
            <label class="text-[10px] text-text-muted uppercase font-bold tracking-wider mb-1 block ml-1">Date de la s√©ance</label>
            <input type="date" id="session-date" class="input-dark text-center text-slate-300 font-mono">
            <script>document.getElementById('session-date').valueAsDate = new Date();</script>
        </div>
        <div id="app-content"></div>
    </div>

    <div id="view-history" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="history" class="w-5 h-5 text-primary"></i> Historique</h2>
        <div id="history-list" class="space-y-3 pb-4"></div>
    </div>

	<div id="view-stats" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <i data-lucide="bar-chart-2" class="w-5 h-5 text-primary"></i> Performance
        </h2>
        <div id="stats-container" class="space-y-4 pb-8"></div>
    </div>

    <div id="view-nutrition" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="utensils" class="w-5 h-5 text-primary"></i> Coach Nutrition</h2>
        
        <div class="card relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h3 class="font-bold text-white flex items-center gap-2">
                            <i data-lucide="glass-water" class="w-4 h-4 text-primary-light"></i> Hydratation
                        </h3>
                        <p class="text-xs text-primary-light" id="water-text">0 / 2500 ml</p>
                    </div>
                    <button onclick="updateWater(-250)" class="text-text-muted hover:text-red-400 transition-colors p-2" title="Enlever 250ml">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div class="water-bar-bg"><div id="water-bar" class="water-bar-fill"></div></div>

                <div class="grid grid-cols-2 gap-3 mt-3">
                    <button onclick="updateWater(100)" class="bg-slate-700/50 hover:bg-slate-600 border border-slate-600 text-slate-200 py-2 rounded-lg text-xs font-bold transition-colors">
                        + 100ml
                    </button>
                    <button onclick="updateWater(250)" class="bg-primary hover:bg-primary-hover text-white py-2 rounded-lg text-xs font-bold transition-colors shadow-lg">
                        + 250ml
                    </button>
                </div>
            </div>
        </div>

        <div class="card mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-white text-sm">Eau : 7 Derniers jours</h3>
                <span class="text-xs text-primary font-bold bg-slate-900/30 px-2 py-1 rounded" id="water-avg">Moy: 0L</span>
            </div>
            <div id="water-chart" class="h-32 w-full flex items-end justify-between gap-1 px-1"></div>
        </div>

        <div id="nutrition-list" class="space-y-3 mb-8"></div>

        <h3 class="text-md font-bold text-white mb-3 mt-8 flex items-center gap-2">
            <i data-lucide="book-open" class="w-4 h-4 text-emerald-400"></i> Guide Macro-Nutriments
        </h3>
        
        <div class="grid grid-cols-2 gap-3 pb-8">
            <div class="card p-3 !mb-0 border-orange-500/30">
                <h4 class="text-xs font-bold text-orange-300 mb-2 uppercase flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> Glucides</h4>
                <div class="space-y-1"><div class="food-item">ü•£ Avoine / Sarrasin</div><div class="food-item">üçö Riz Basmati</div><div class="food-item">üç† Patate Douce</div></div>
            </div>
            <div class="card p-3 !mb-0 border-blue-500/30">
                <h4 class="text-xs font-bold text-blue-300 mb-2 uppercase flex items-center gap-1"><i data-lucide="dumbbell" class="w-3 h-3"></i> Prot√©ines</h4>
                <div class="space-y-1"><div class="food-item">üçó Poulet / Dinde</div><div class="food-item">ü•ö ≈íufs</div><div class="food-item">üêü Poisson</div></div>
            </div>
            <div class="card p-3 !mb-0 border-yellow-500/30">
                <h4 class="text-xs font-bold text-yellow-300 mb-2 uppercase flex items-center gap-1"><i data-lucide="droplet" class="w-3 h-3"></i> Lipides</h4>
                <div class="space-y-1"><div class="food-item">ü•ë Avocat</div><div class="food-item">ü´í Huile d'Olive</div><div class="food-item">ü•ú Noix</div></div>
            </div>
            <div class="card p-3 !mb-0 border-emerald-500/30">
                <h4 class="text-xs font-bold text-emerald-300 mb-2 uppercase flex items-center gap-1"><i data-lucide="carrot" class="w-3 h-3"></i> Fibres</h4>
                <div class="space-y-1"><div class="food-item">ü•¶ Brocoli</div><div class="food-item">ü•ó √âpinards</div> <div class="food-item">üå∞ Amandes</div></div>
            </div>
        </div>
    </div>

    <div id="view-settings" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4">Centre de Contr√¥le</h2>
        
        <div class="card border-l-4 border-l-purple-500">
            <h3 class="font-bold text-white mb-3 flex items-center gap-2"><i data-lucide="user-circle" class="w-5 h-5 text-purple-400"></i> Profil & Biom√©trie</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div><label class="text-[10px] text-text-muted uppercase font-bold">Taille (cm)</label><input type="number" id="user-height" class="input-dark" placeholder="175" onchange="saveSettings()"></div>
                <div><label class="text-[10px] text-text-muted uppercase font-bold">Age</label><input type="number" id="user-age" class="input-dark" placeholder="25" onchange="saveSettings()"></div>
            </div>
            <div class="mb-4">
                <div class="flex justify-between items-center mb-1"><label class="text-[10px] text-text-muted uppercase font-bold">Objectif Poids (kg)</label></div>
                <input type="number" step="0.1" id="user-target-weight" class="input-dark" placeholder="75.0" onchange="saveSettings()">
            </div>
            <div id="bio-stats" class="bg-slate-900/50 p-3 rounded-lg text-center text-xs text-slate-300 border border-slate-700">Remplis tes infos.</div>
        </div>

        <div class="card">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="sliders" class="w-5 h-5 text-primary"></i> Pr√©f√©rences</h3>
            <div class="flex justify-between items-center mb-4">
                <span class="text-sm text-slate-300 font-medium">Sons (Timer)</span>
                <div><input type="checkbox" id="pref-sound" class="toggle-checkbox" onchange="saveSettings()" checked><label for="pref-sound" class="toggle-label"></label></div>
            </div>
            <div class="flex justify-between items-center mb-4">
                <span class="text-sm text-slate-300 font-medium">Vibration Haptique</span>
                <div><input type="checkbox" id="pref-vibe" class="toggle-checkbox" onchange="saveSettings()" checked><label for="pref-vibe" class="toggle-label"></label></div>
            </div>
            <div class="mb-2">
                 <div class="flex justify-between mb-1"><label class="text-[10px] text-text-muted uppercase font-bold">Objectif Eau</label><span class="text-xs text-primary font-bold" id="water-val-disp">2500ml</span></div>
                 <input type="range" id="pref-water" min="1500" max="4000" step="250" class="w-full accent-[var(--primary)]" onchange="saveSettings(); document.getElementById('water-val-disp').innerText = this.value + 'ml'">
            </div>
        </div>

        <div class="card">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="palette" class="w-5 h-5 text-primary-light"></i> Apparence</h3>
            
            <label class="text-[10px] text-text-muted uppercase font-bold mb-2 block">Couleur Principale</label>
            <div class="flex flex-wrap gap-3 mb-6">
                <button onclick="setAppTheme('blue')" class="w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-offset-[#1e293b] ring-transparent hover:ring-white transition-all focus:ring-white"></button>
                <button onclick="setAppTheme('purple')" class="w-8 h-8 rounded-full bg-purple-500 ring-2 ring-offset-2 ring-offset-[#1e293b] ring-transparent hover:ring-white transition-all focus:ring-white"></button>
                <button onclick="setAppTheme('emerald')" class="w-8 h-8 rounded-full bg-emerald-500 ring-2 ring-offset-2 ring-offset-[#1e293b] ring-transparent hover:ring-white transition-all focus:ring-white"></button>
                <button onclick="setAppTheme('orange')" class="w-8 h-8 rounded-full bg-orange-500 ring-2 ring-offset-2 ring-offset-[#1e293b] ring-transparent hover:ring-white transition-all focus:ring-white"></button>
                <button onclick="setAppTheme('pink')" class="w-8 h-8 rounded-full bg-pink-500 ring-2 ring-offset-2 ring-offset-[#1e293b] ring-transparent hover:ring-white transition-all focus:ring-white"></button>
                <button onclick="setAppTheme('cyan')" class="w-8 h-8 rounded-full bg-cyan-400 ring-2 ring-offset-2 ring-offset-[#1e293b] ring-transparent hover:ring-white transition-all focus:ring-white"></button>
            </div>

            <label class="text-[10px] text-text-muted uppercase font-bold mb-2 block">Ambiance de fond</label>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setAppBg('slate')" class="bg-[#0f172a] border border-slate-600 text-xs text-slate-300 py-2 rounded-lg hover:border-white transition-colors">D√©faut</button>
                <button onclick="setAppBg('deep')" class="bg-[#000000] border border-slate-800 text-xs text-slate-400 py-2 rounded-lg hover:border-white transition-colors">AMOLED</button>
                <button onclick="setAppBg('midnight')" class="bg-[#1e1b4b] border border-indigo-900 text-xs text-indigo-300 py-2 rounded-lg hover:border-white transition-colors">Midnight</button>
            </div>
        </div>

		<div class="card border-slate-700">
			<h3 class="font-bold text-white mb-3 flex items-center gap-2"><i data-lucide="list" class="w-5 h-5 text-text-muted"></i> Programme</h3>
			<button onclick="switchTab('editor', document.querySelector('.nav-item.active'))" class="btn-secondary text-xs mb-2">
				<i data-lucide="edit" class="w-3 h-3"></i> Modifier la Semaine
			</button>
		</div>

        <div class="card border-slate-700">
            <h3 class="font-bold text-white mb-3 flex items-center gap-2"><i data-lucide="hard-drive" class="w-5 h-5 text-text-muted"></i> Donn√©es</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <button onclick="exportData()" class="btn-secondary text-xs"><i data-lucide="download" class="w-3 h-3"></i> Sauvegarder</button>
                <button onclick="document.getElementById('import-file').click()" class="btn-secondary text-xs"><i data-lucide="upload" class="w-3 h-3"></i> Restaurer</button>
            </div>
			
			<button onclick="clearData()" class="w-full py-3 text-red-400 text-xs font-bold border border-red-900/50 rounded-lg hover:bg-red-900/20">R√©initialisation Usine</button>
            <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
        </div>

        <div class="text-center text-[10px] text-text-muted mt-6 pb-4">
            <p>Gym & Run Tracker v1.9.2</p>
			<p>Made by L√©o L.</p>
        </div>
    </div>
		
		
	<div id="view-editor" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <i data-lucide="edit-3" class="w-5 h-5 text-primary"></i> √âditeur de Programme
        </h2>

        <div class="mb-6">
            <label class="text-[10px] text-text-muted uppercase font-bold tracking-wider mb-2 block ml-1">Jour √† modifier</label>
            <div class="relative">
                <select id="edit-day-selector" onchange="loadDayEditor(this.value)" class="w-full bg-card text-white border border-slate-600 rounded-xl p-3.5 font-bold focus:outline-none focus:border-primary shadow-lg appearance-none">
                    </select>
            </div>
        </div>

        <div id="editor-content" class="space-y-4">
            </div>
        
		<div class="card border-t-4 border-t-indigo-500 mt-6 pt-4">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="archive" class="w-5 h-5 text-indigo-400"></i> Biblioth√®que & Partage
            </h3>
			
			<div class="bg-slate-800 p-4 rounded-xl border border-dashed border-slate-600 mb-6">
				<h4 class="text-xs font-bold text-indigo-300 uppercase mb-2 flex items-center gap-2">
					<i data-lucide="bot" class="w-4 h-4"></i> G√©n√©rer avec l'IA
				</h4>
				<p class="text-[10px] text-slate-400 mb-3">
					Copiez notre mod√®le de demande, compl√©tez-le avec vos objectifs et envoyez-le √† ChatGPT/Gemini pour obtenir un fichier JSON compatible.
				</p>
				<button onclick="copyAiPrompt()" class="w-full py-2 bg-indigo-500/20 hover:bg-indigo-500/40 text-indigo-200 text-xs font-bold rounded-lg border border-indigo-500/50 transition-colors flex justify-center items-center gap-2">
					<i data-lucide="copy" class="w-3 h-3"></i> Copier le Prompt Mod√®le
				</button>
			</div>

			
            <label class="text-[10px] text-text-muted uppercase font-bold mb-2 block">Fichier externe (.json)</label>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="exportProgramJSON()" class="btn-secondary text-xs border border-indigo-500/30">
                    <i data-lucide="download" class="w-3 h-3"></i> Exporter
                </button>
                <button onclick="document.getElementById('import-prog-file').click()" class="btn-secondary text-xs border border-indigo-500/30">
                    <i data-lucide="upload" class="w-3 h-3"></i> Importer
                </button>
                <input type="file" id="import-prog-file" class="hidden" accept=".json" onchange="importProgramJSON(this)">
            </div>

            <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700/50">
                <label class="text-[10px] text-text-muted uppercase font-bold mb-2 block">Mes Programmes Sauvegard√©s</label>
                
                <div class="flex gap-2 mb-4">
                    <input type="text" id="prog-save-name" class="input-dark text-xs" placeholder="Nom (ex: PPL Force)">
                    <button onclick="saveProgramToLibrary()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 rounded-lg text-xs font-bold transition-colors shadow-lg shadow-indigo-900/20" title="Sauvegarder">
                        <i data-lucide="save" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="flex gap-2">
                    <div class="relative w-full">
                        <select id="library-selector" class="w-full bg-slate-800 text-white border border-slate-600 rounded-lg p-2.5 text-xs font-bold focus:outline-none appearance-none">
                            <option value="">-- Choisir un programme --</option>
                        </select>
                    </div>
                    <button onclick="loadProgramFromLibrary()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 rounded-lg transition-colors border border-emerald-500" title="Charger ce programme">
                        <i data-lucide="check" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteProgramFromLibrary()" class="bg-red-900/50 hover:bg-red-900 text-red-200 px-3 rounded-lg border border-red-800 transition-colors" title="Supprimer">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
		
		
        <div class="mt-8 flex gap-3">
             <button onclick="saveCustomProgram()" class="btn-primary shadow-xl">Sauvegarder Tout</button>
             <button onclick="resetProgram()" class="btn-secondary text-red-400 border border-red-900/30">R√©tablir D√©faut</button>
        </div>
    </div>
	
	<footer style = "padding-top: 80px">
		<nav class="navbar">
			<div class="nav-item active" onclick="switchTab('tracker', this)"><i data-lucide="dumbbell"></i><span>S√©ance</span></div>
			<div class="nav-item" onclick="switchTab('history', this)"><i data-lucide="calendar-days"></i><span>Journal</span></div>
			<div class="nav-item" onclick="switchTab('stats', this)"><i data-lucide="bar-chart-2"></i><span>Stats</span></div>
			<div class="nav-item" onclick="switchTab('nutrition', this)"><i data-lucide="utensils"></i><span>Nutri</span></div>
			<div class="nav-item" onclick="switchTab('settings', this)"><i data-lucide="settings"></i><span>Outils</span></div>
		</nav>
	</footer>
	
    <div id="calc-modal" onclick="closeCalc()">
        <div class="bg-slate-900 p-6 rounded-2xl w-80 text-center border border-slate-700 shadow-2xl transform scale-100" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-white mb-2">Charger la Barre</h3>
            <p class="text-slate-400 text-sm mb-4">Objectif : <span id="calc-target" class="text-primary font-bold text-lg">0</span> kg</p>
            <div id="calc-result" class="bg-slate-800 p-4 rounded-xl mb-4 min-h-[80px] flex flex-wrap justify-center items-center gap-1"></div>
            <div class="text-xs text-slate-500 mb-4">Barre olympique standard (20kg)</div>
            <button onclick="closeCalc()" class="btn-primary">Fermer</button>
        </div>
    </div>

    <div id="toast"><span id="toast-msg">Message</span></div>
    <audio id="timer-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
    // --- 1. SETTINGS & THEME LOGIC (AVANC√â) ---
    const THEMES = {
        blue:   { main: '#3b82f6', hover: '#2563eb', light: '#60a5fa' },
        purple: { main: '#8b5cf6', hover: '#7c3aed', light: '#a78bfa' },
        emerald:{ main: '#10b981', hover: '#059669', light: '#34d399' },
        orange: { main: '#f97316', hover: '#ea580c', light: '#fb923c' },
        pink:   { main: '#ec4899', hover: '#db2777', light: '#f472b6' },
        cyan:   { main: '#06b6d4', hover: '#0891b2', light: '#22d3ee' }
    };

    const BACKGROUNDS = {
        slate:    { body: '#0f172a', card: '#1e293b' }, // Default
        deep:     { body: '#000000', card: '#121212' }, // AMOLED
        midnight: { body: '#0f1021', card: '#1a1b35' }  // Deep Blue
    };

    let appSettings = {
        height: null, age: null, targetWeight: null, waterGoal: 2500, 
        sound: true, vibe: true, 
        themeColor: 'blue', themeBg: 'slate'
    };

    function loadSettings() {
        const saved = localStorage.getItem('gym_tracker_settings');
        if(saved) appSettings = { ...appSettings, ...JSON.parse(saved) };
        
        // UI Defaults
        document.getElementById('user-height').value = appSettings.height || '';
        document.getElementById('user-age').value = appSettings.age || '';
        document.getElementById('user-target-weight').value = appSettings.targetWeight || '';
        document.getElementById('pref-sound').checked = appSettings.sound;
        document.getElementById('pref-vibe').checked = appSettings.vibe;
        document.getElementById('pref-water').value = appSettings.waterGoal;
        document.getElementById('water-val-disp').innerText = appSettings.waterGoal + 'ml';
        
        // Appliquer Th√®me
        setAppTheme(appSettings.themeColor, false);
        setAppBg(appSettings.themeBg, false);
        calcBio();
    }

    function setAppTheme(colorKey, save = true) {
        if (!THEMES[colorKey]) colorKey = 'blue';
        const t = THEMES[colorKey];
        const root = document.documentElement;
        root.style.setProperty('--primary', t.main);
        root.style.setProperty('--primary-hover', t.hover);
        root.style.setProperty('--primary-light', t.light);
        if(save) { appSettings.themeColor = colorKey; saveSettings(); }
    }

    function setAppBg(bgKey, save = true) {
        if (!BACKGROUNDS[bgKey]) bgKey = 'slate';
        const b = BACKGROUNDS[bgKey];
        const root = document.documentElement;
        root.style.setProperty('--bg-body', b.body);
        root.style.setProperty('--bg-card', b.card);
        if(save) { appSettings.themeBg = bgKey; saveSettings(); }
    }

    function saveSettings() {
        appSettings.height = document.getElementById('user-height').value;
        appSettings.age = document.getElementById('user-age').value;
        appSettings.targetWeight = document.getElementById('user-target-weight').value;
        appSettings.sound = document.getElementById('pref-sound').checked;
        appSettings.vibe = document.getElementById('pref-vibe').checked;
        appSettings.waterGoal = parseInt(document.getElementById('pref-water').value);
        localStorage.setItem('gym_tracker_settings', JSON.stringify(appSettings));
        calcBio(); updateWaterDisplay();
    }

    function calcBio() {
        const h = parseInt(appSettings.height); const a = parseInt(appSettings.age);
        if(h && a) {
            const weight = 75; // Poids moyen par d√©faut si pas de module poids
            const bmr = (10 * weight) + (6.25 * h) - (5 * a) + 5;
            const imc = (weight / ((h/100)*(h/100))).toFixed(1);
            document.getElementById('bio-stats').innerHTML = `<div class="flex justify-around"><div><div class="text-xs text-slate-400">IMC (Est.)</div><div class="text-lg font-bold text-white">${imc}</div></div><div><div class="text-xs text-slate-400">BMR (Repos)</div><div class="text-lg font-bold text-white">${Math.round(bmr)} kcal</div></div></div>`;
        }
    }

    // --- 2. DONN√âES DU PROGRAMME ---
// --- 2. GESTION DU PROGRAMME (DYNAMIQUE) ---
    
    // Programme par d√©faut (Backup)
    const defaultProgram = {
        1: { type: 'muscu', title: 'Lundi : PUSH', desc: 'Pecs, √âpaules, Triceps', exercises: [{ name: 'D√©velopp√© Couch√©', sets: 4, reps: '6-10', rest: '2-3 min' }, { name: 'D√©velopp√© Inclin√© Halt√®res', sets: 3, reps: '8-12', rest: '2 min' }, { name: 'D√©velopp√© Militaire', sets: 3, reps: '8-12', rest: '2 min' }, { name: '√âl√©vations Lat√©rales', sets: 4, reps: '12-15', rest: '1m30' }, { name: 'Extensions Triceps Poulie', sets: 3, reps: '10-15', rest: '1m30' }]},
        2: { type: 'cardio', title: 'Mardi : RUNNING', desc: 'Endurance Fondamentale', exercises: [{ name: 'Course √† pied', sets: 1, reps: '45-60 min', rest: 'N/A' }]},
        3: { type: 'muscu', title: 'Mercredi : PULL', desc: 'Dos, Arri√®re √©paule, Biceps', exercises: [{ name: 'Tractions', sets: 4, reps: 'Max', rest: '2-3 min' }, { name: 'Rowing Barre', sets: 3, reps: '8-12', rest: '2 min' }, { name: 'Tirage Horizontal', sets: 3, reps: '10-12', rest: '1m30' }, { name: 'Face Pulls', sets: 4, reps: '15-20', rest: '1m30' }, { name: 'Curl Barre', sets: 3, reps: '8-12', rest: '1m30' }]},
        4: { type: 'cardio', title: 'Jeudi : RUNNING', desc: 'Endurance - Hydratation ++', exercises: [{ name: 'Course √† pied', sets: 1, reps: '45-60 min', rest: 'N/A' }]},
        5: { type: 'muscu', title: 'Vendredi : UPPER BODY', desc: 'Volume & Rappel', exercises: [{ name: 'Dips', sets: 3, reps: '8-12', rest: '2 min' }, { name: 'Tirage Vertical Supination', sets: 3, reps: '8-12', rest: '2 min' }, { name: '√âcart√© Poulie Vis-√†-vis', sets: 3, reps: '12-15', rest: '1m30' }, { name: 'Curl Marteau', sets: 3, reps: '10-15', rest: '1m30' }, { name: 'Extension Triceps T√™te', sets: 3, reps: '10-15', rest: '1m30' }]},
        6: { type: 'cardio', title: 'Samedi : RUNNING', desc: 'Sortie Longue / Plaisir', exercises: [{ name: 'Course √† pied', sets: 1, reps: 'Libre', rest: 'N/A' }]},
        0: { type: 'rest', title: 'Dimanche : REPOS', desc: 'R√©cup√©ration - Low Carb', exercises: [] }
    };

    // Variable globale qui contiendra le programme actif
    let activeProgram = {};

    function loadProgram() {
        const saved = localStorage.getItem('gym_tracker_program');
        if (saved) {
            activeProgram = JSON.parse(saved);
        } else {
            activeProgram = JSON.parse(JSON.stringify(defaultProgram)); // Clone profond
        }
    }

    // Charge le programme au d√©marrage
    loadProgram();

    // --- 3. INIT & NAVIGATION ---
    const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
    let currentDayIndex = new Date().getDay();
    const selector = document.getElementById('day-selector');
    days.forEach((day, index) => {
        let option = document.createElement('option'); option.value = index; option.text = activeProgram[index].title;
        if(index === currentDayIndex) option.selected = true; selector.add(option);
    });

    lucide.createIcons();
    loadSettings();
    loadDailyView(currentDayIndex);

	function switchTab(tabId, element) {
        document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active'));
        // Cas particulier pour l'√©diteur qui n'est pas dans la navbar principale
        if(tabId === 'editor') {
            document.getElementById('view-editor').classList.add('active');
            // Charge le jour actuel par d√©faut dans l'√©diteur
            document.getElementById('edit-day-selector').value = currentDayIndex;
            loadDayEditor(currentDayIndex);
        } else {
            document.getElementById('view-' + tabId).classList.add('active');
        }

        // Gestion de la classe active sur la navbar (seulement si l'√©l√©ment est dans la navbar)
        if(element && element.classList.contains('nav-item')) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }
        
        if(tabId === 'history') renderHistory();
        if(tabId === 'stats') renderStats();
        if(tabId === 'nutrition') { renderNutrition(); updateWaterDisplay(); renderWaterChart(); }
        
        const titles = { 'tracker': 'Gym & Run', 'history': 'Journal', 'stats': 'Statistiques', 'nutrition': 'Coach Nutri', 'settings': 'Outils', 'editor': '√âditeur' };
        document.getElementById('header-title').innerText = titles[tabId] || 'Gym & Run';
    }

    function manualDayChange(val) { currentDayIndex = parseInt(val); loadDailyView(currentDayIndex); }

    // --- 4. WORKOUT LOGIC ---
    function getCoachAdvice(lastData, targetRepString) {
        if(!lastData) return null;
        let maxTarget = 12; const rangeMatch = targetRepString.match(/-(\d+)/);
        if(rangeMatch) maxTarget = parseInt(rangeMatch[1]); else if (targetRepString.includes('Max')) maxTarget = 20;
        const lastWeight = parseFloat(lastData.val1.replace(',','.')); const lastReps = parseInt(lastData.val2.split(',')[0]);
        if(isNaN(lastWeight) || isNaN(lastReps)) return null;
        if (lastReps >= maxTarget) return { type: 'weight', val1: lastWeight + 2.5, val2: targetRepString, msg: `+2.5kg !` };
        else return { type: 'reps', val1: lastWeight, val2: lastReps + 1, msg: `Vise ${lastReps + 1} reps` };
    }

    function loadDailyView(dayIndex) {
        const contentDiv = document.getElementById('app-content');
        const dayPlan = activeProgram[dayIndex];

        if (dayPlan.type === 'rest') {
            // ... (Code repos inchang√©, je l'abr√®ge ici pour la clart√©) ...
            contentDiv.innerHTML = `<div class="card text-center py-12 border-t-4 border-emerald-500 bg-gradient-to-b from-emerald-900/20 to-slate-900/10"><div class="bg-emerald-900/30 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border border-emerald-500/30"><i data-lucide="coffee" class="w-10 h-10 text-emerald-400"></i></div><h2 class="text-2xl font-bold text-white">Repos</h2><p class="text-slate-400 mt-2 text-sm">${dayPlan.desc}</p><div class="mt-8 bg-card p-5 rounded-xl text-left text-sm border border-slate-700"><p class="text-emerald-400 font-bold mb-2 flex items-center gap-2 text-xs uppercase tracking-wide"><i data-lucide="leaf" class="w-4 h-4"></i> Nutrition</p><p class="text-slate-300">Moins de glucides, plus de l√©gumes et bons lipides (avocat, noix).</p></div></div>`;
            lucide.createIcons(); return;
        }

        const isCardio = dayPlan.type === 'cardio';
        let html = `<form id="workout-form" onsubmit="event.preventDefault();">`;

        dayPlan.exercises.forEach((exo, index) => {
            const historyData = getHistoryData(exo.name); const lastData = historyData.last;
            
            // --- GESTION DE L'AFFICHAGE DU HEADER (MODIFI√â) ---
            let headerInfo = '';
            if (isCardio) {
                // Version Cardio : Affiche l'objectif (stock√© dans 'reps')
                headerInfo = `<div class="text-xs text-amber-400 mt-1 mb-2 font-bold flex items-center gap-2">
                                <span class="bg-amber-900/30 px-2 py-1 rounded border border-amber-700/50 flex items-center gap-1">
                                    <i data-lucide="crosshair" class="w-3 h-3"></i> ${exo.reps}
                                </span>
                              </div>`;
            } else {
                // Version Muscu : Affiche S√©ries et Reps
                headerInfo = `<div class="text-xs text-text-muted mt-1 mb-2 font-medium flex items-center gap-2">
                                <span class="bg-slate-700/50 px-1.5 py-0.5 rounded text-slate-300 border border-slate-600">${exo.sets} s√©ries</span>
                                <span class="text-slate-600">‚Ä¢</span>
                                <span>${exo.reps} reps</span>
                              </div>`;
            }

            let historyHTML = !lastData ? `<div class="text-xs text-text-muted mb-3 italic flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> Pas d'historique</div>` : '';
            if (lastData) {
                const lastText = isCardio ? `${lastData.val1}km / ${lastData.val2}` : `${lastData.val1}kg x ${lastData.val2}`;
                let coachHTML = '';
                if(!isCardio) {
                    const advice = getCoachAdvice(lastData, exo.reps);
                    if(advice) coachHTML = `<div onclick="fillInputs(${index}, '${advice.val1}', '${advice.val2}')" class="clickable-history coach"><i data-lucide="sparkles" class="w-3 h-3"></i> Coach: <strong>${advice.msg}</strong></div>`;
                }
                historyHTML = `<div class="flex gap-2 mb-3 overflow-x-auto no-scrollbar"><div onclick="fillInputs(${index}, '${lastData.val1}', '${lastData.val2}')" class="clickable-history last"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> Last: <strong>${lastText}</strong></div>${coachHTML}</div>`;
            }

            let actionBtn = (!isCardio && exo.rest !== 'N/A') ? `<button type="button" class="timer-btn" onclick="startTimer(this, ${parseRestToSeconds(exo.rest)})"><i data-lucide="timer" class="w-3 h-3"></i> ${exo.rest}</button>` : '';
            let calcBtn = (!isCardio && !exo.name.includes('Halt√®res') && !exo.name.includes('Poulie')) ? `<i data-lucide="scale" class="w-4 h-4 text-text-muted absolute right-3 top-3.5 cursor-pointer" onclick="openCalc(document.getElementById('val1_${index}').value)"></i>` : '';

            // Labels inputs
            const label1 = isCardio ? "Distance (km)" : "Charge (kg)";
            const ph1 = isCardio ? "8.5" : "60";
            const label2 = isCardio ? "Temps (min)" : "Reps";
            const ph2 = isCardio ? "45:00" : "10,10,9";

            html += `
            <div class="card relative overflow-hidden">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-bold text-lg text-white flex items-center gap-2 leading-tight">${exo.name}</h3>
                        ${headerInfo}
                    </div>
                    ${actionBtn}
                </div>
                ${historyHTML}
                <div class="grid grid-cols-2 gap-3 relative">
                    <div>
                        <label class="text-[10px] text-text-muted uppercase font-bold tracking-wider mb-1.5 block ml-1">${label1}</label>
                        <div class="relative"><input type="number" id="val1_${index}" name="val1_${index}" class="input-dark font-mono text-center text-white pl-2 pr-6" placeholder="${ph1}" inputmode="decimal">${calcBtn}</div>
                    </div>
                    <div>
                        <label class="text-[10px] text-text-muted uppercase font-bold tracking-wider mb-1.5 block ml-1">${label2}</label>
                        <input type="text" id="val2_${index}" name="val2_${index}" class="input-dark font-mono text-center text-white" placeholder="${ph2}" inputmode="text">
                    </div>
                </div>
            </div>`;
        });

        html += `<div class="card"><label class="text-xs text-text-muted uppercase font-bold tracking-wider mb-2 block flex items-center gap-2"><i data-lucide="sticky-note" class="w-3 h-3"></i> Notes</label><textarea name="notes" class="input-dark text-sm min-h-[60px] font-normal text-slate-300" placeholder="Sensations..."></textarea></div><button type="button" onclick="saveWorkout(${dayIndex})" class="btn-primary mb-8 text-lg shadow-xl">Valider la s√©ance</button></form>`;
        contentDiv.innerHTML = html; lucide.createIcons();
    }

    // --- 5. WATER LOGIC ---
    function getWater() {
        const todayStr = new Date().toLocaleDateString('fr-FR');
        const data = JSON.parse(localStorage.getItem('gym_tracker_water') || '[]');
        const entry = data.find(d => d.date === todayStr);
        return entry ? entry.amount : 0;
    }

    function updateWater(amount) {
        const todayStr = new Date().toLocaleDateString('fr-FR');
        let data = JSON.parse(localStorage.getItem('gym_tracker_water') || '[]');
        let index = data.findIndex(d => d.date === todayStr);
        if(index !== -1) { let newAmount = data[index].amount + amount; if (newAmount < 0) newAmount = 0; data[index].amount = newAmount; } 
        else if (amount > 0) data.push({ date: todayStr, amount: amount });
        localStorage.setItem('gym_tracker_water', JSON.stringify(data));
        updateWaterDisplay(); renderWaterChart();
        if(appSettings.vibe && navigator.vibrate) navigator.vibrate(50);
    }

    function updateWaterDisplay() {
        const current = getWater(); const max = appSettings.waterGoal || 2500;
        const pct = Math.min((current / max) * 100, 100);
        document.getElementById('water-text').innerText = `${current} / ${max} ml`;
        document.getElementById('water-bar').style.width = `${pct}%`;
    }

    function renderWaterChart() {
        const container = document.getElementById('water-chart');
        const data = JSON.parse(localStorage.getItem('gym_tracker_water') || '[]');
        const last7Days = []; let totalWeek = 0; const goalScale = appSettings.waterGoal || 2500; 

        for (let i = 6; i >= 0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const dateStr = d.toLocaleDateString('fr-FR');
            const entry = data.find(item => item.date === dateStr);
            const amount = entry ? entry.amount : 0;
            totalWeek += amount;
            last7Days.push({ day: d.toLocaleDateString('fr-FR', { weekday: 'short' }), amount: amount });
        }
        
        document.getElementById('water-avg').innerText = `Moy: ${(Math.round(totalWeek / 7)/1000).toFixed(1)}L`;
        let html = '';
        last7Days.forEach(day => {
            const heightPct = Math.min((day.amount / goalScale) * 100, 100);
            const isGoalMet = day.amount >= goalScale;
            // Utilisation des classes dynamiques pour la couleur active
            const colorClass = isGoalMet ? 'bg-primary shadow-[0_0_10px_var(--primary)]' : 'bg-slate-700';
            html += `<div class="flex flex-col items-center w-full group relative h-full justify-end"><div class="w-full ${colorClass} rounded-t-sm transition-all duration-500 relative group-hover:bg-primary-light" style="height: ${heightPct}%"><span class="absolute -top-8 left-1/2 -translate-x-1/2 text-[10px] bg-slate-900 text-white px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap border border-slate-600 z-10 pointer-events-none">${day.amount}ml</span></div><span class="text-[9px] text-text-muted mt-1 uppercase font-bold">${day.day.replace('.','').substr(0,2)}</span><div class="absolute bottom-[100%] border-b border-dashed border-slate-600/50 w-[140%] -left-[20%] pointer-events-none"></div></div>`;
        });
        container.innerHTML = html;
    }

    // --- 6. RENDER NUTRITION ---
    async function renderNutrition() {
        const list = document.getElementById('nutrition-list');
        try {
            const response = await fetch('nutrition.json');
            if (!response.ok) throw new Error("Erreur");
            const nutriPlan = await response.json();
            let html = ''; const today = new Date().getDay(); const orderedDays = [1, 2, 3, 4, 5, 6, 0];
            
            orderedDays.forEach(dayIndex => {
                const item = nutriPlan.find(p => p.day === dayIndex); if(!item) return;
                const isToday = item.day === today;
                // La carte active utilise bg-slate-800 avec une bordure primary
                const activeClass = isToday ? 'border-l-4 border-l-[var(--primary)] bg-slate-800 shadow-lg' : 'opacity-70 grayscale hover:grayscale-0 transition-all';
                const icon = item.type === 'muscu' ? 'dumbbell' : (item.type === 'run' ? 'footprints' : 'coffee');
                let tag = item.type === 'muscu' ? '<span class="meal-tag tag-muscu">Force</span>' : (item.type === 'run' ? '<span class="meal-tag tag-run">Cardio</span>' : '<span class="meal-tag tag-rest">Repos</span>');
                let detailsHtml = '<ul class="text-xs text-slate-300 space-y-1 list-disc pl-4 mt-2">';
                item.details.forEach(detail => detailsHtml += `<li><strong>${detail.label}:</strong> ${detail.text}</li>`);
                html += `<div class="card ${activeClass} mb-3" id="day-${item.day}"><div class="flex justify-between items-center mb-1"><div class="flex items-center gap-2"><i data-lucide="${icon}" class="w-4 h-4 text-slate-400"></i><h3 class="font-bold text-white text-sm">${item.title}</h3></div>${tag}</div>${detailsHtml}</ul></div>`;
            });
            list.innerHTML = html; lucide.createIcons();
            if(document.querySelector('.border-l-[var(--primary)]')) setTimeout(() => document.querySelector('.border-l-[var(--primary)]').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        } catch (error) { list.innerHTML = `<div class="text-red-400 text-center p-4 border border-red-900 rounded-lg bg-red-900/10 text-xs">Fichier nutrition.json introuvable.</div>`; }
    }

    // --- 7. HELPERS & CHARTS ---
    function saveWorkout(dayIndex) {
        const form = document.getElementById('workout-form');
        const dayPlan = activeProgram[dayIndex];
        const dateInput = document.getElementById('session-date').value;
        let dateStr, timestamp; if (dateInput) { const [y, m, d] = dateInput.split('-'); dateStr = `${d}/${m}/${y}`; timestamp = new Date(y, m - 1, d).getTime(); } else { const now = new Date(); dateStr = now.toLocaleDateString('fr-FR'); timestamp = now.getTime(); }
        let sessionData = { date: dateStr, timestamp: timestamp, title: dayPlan.title, type: dayPlan.type, notes: form.notes ? form.notes.value : "", exercises: [] };
        dayPlan.exercises.forEach((exo, index) => { const val1 = form[`val1_${index}`].value; const val2 = form[`val2_${index}`].value; if(val1 || val2) sessionData.exercises.push({ name: exo.name, val1: val1 || '-', val2: val2 || '-' }); });
        if (sessionData.exercises.length === 0) { showToast("Vide !", true); return; }
        let history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        history.unshift(sessionData); history.sort((a, b) => b.timestamp - a.timestamp);
        localStorage.setItem('gym_tracker_data_v2', JSON.stringify(history));
        showToast("Valid√© ! üî•"); form.reset(); document.getElementById('session-date').valueAsDate = new Date(); loadDailyView(dayIndex);
    }

	function renderStats() {
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        const container = document.getElementById('stats-container');
        
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        // Initialisation des compteurs
        const stats = {
            month: { gymSessions: 0, runSessions: 0, runKm: 0 },
            total: { gymSessions: 0, runSessions: 0, runKm: 0 }
        };

        history.forEach(session => {
            const [d, m, y] = session.date.split('/').map(Number);
            const isThisMonth = (m - 1) === currentMonth && y === currentYear;

            if (session.type === 'muscu') {
                stats.total.gymSessions++;
                if (isThisMonth) stats.month.gymSessions++;
            } else if (session.type === 'cardio') {
                stats.total.runSessions++;
                if (isThisMonth) stats.month.runSessions++;

                // Calcul distance
                session.exercises.forEach(ex => {
                    const km = parseFloat(ex.val1.replace(',', '.'));
                    if (!isNaN(km)) {
                        stats.total.runKm += km;
                        if (isThisMonth) stats.month.runKm += km;
                    }
                });
            }
        });

        // --- R√©cup√©ration et formatage du temps total ---
        const totalSeconds = parseInt(localStorage.getItem('gym_tracker_time_spent') || '0');
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const timeString = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

        // Fonction utilitaire pour g√©n√©rer une carte
        const statCard = (title, val1, label1, val2, label2, icon, colorClass) => `
            <div class="card relative overflow-hidden border-l-4 ${colorClass}">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                    <i data-lucide="${icon}" class="w-4 h-4"></i> ${title}
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-2xl font-black text-white leading-none">${val1}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase mt-1">${label1}</div>
                    </div>
                    <div class="border-l border-slate-700 pl-4">
                        <div class="text-2xl font-black text-white leading-none">${val2}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase mt-1">${label2}</div>
                    </div>
                </div>
            </div>
        `;

        // G√©n√©ration du HTML
        let html = '';

        // 1. Stats du Mois en cours
        html += statCard(
            "Ce mois-ci", 
            stats.month.gymSessions, "S√©ances Muscu", 
            stats.month.runSessions, "Sorties Run", 
            "calendar", "border-blue-500"
        );

        // 2. Stats Globales (TEMPS & Distance)
        html += statCard(
            "Cumul Global", 
            timeString, "Temps App", // Affiche le temps ici
            stats.total.runKm.toFixed(1), "KM Parcourus", 
            "trophy", "border-amber-500"
        );

        // 3. Total S√©ances simple
        html += `
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-card p-3 rounded-xl border border-slate-700 flex flex-col items-center justify-center py-4">
                    <span class="text-3xl font-black text-primary">${stats.total.gymSessions + stats.total.runSessions}</span>
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Total Activit√©es</span>
                </div>
                 <div class="bg-card p-3 rounded-xl border border-slate-700 flex flex-col items-center justify-center py-4">
                    <span class="text-3xl font-black text-emerald-400">${stats.total.gymSessions}</span>
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Dont Muscu</span>
                </div>
            </div>
        `;

        container.innerHTML = html;
        lucide.createIcons();
    }

    function getHistoryData(exoName) {
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        let last = null, best = null;
        for (let session of history) {
            const found = session.exercises.find(e => e.name === exoName || e.name.includes(exoName));
            if (found) { if(!last) last = found; const val = parseFloat(found.val1.replace(',','.')); if (!isNaN(val) && (!best || val > parseFloat(best.val1.replace(',','.')))) best = found; }
        }
        return { last, best };
    }

    function editSessionDate(index) {
        let history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        const newDateStr = prompt("Date (JJ/MM/AAAA) :", history[index].date);
        if (newDateStr && newDateStr !== history[index].date) {
            const parts = newDateStr.split('/');
            if(parts.length === 3) {
                history[index].date = newDateStr; history[index].timestamp = new Date(parts[2], parts[1]-1, parts[0]).getTime();
                history.sort((a, b) => b.timestamp - a.timestamp);
                localStorage.setItem('gym_tracker_data_v2', JSON.stringify(history));
                renderHistory(); renderStats(); showToast("Modifi√© !");
            }
        }
    }

	function copyAiPrompt() {
		const promptText = `Agis comme un coach sportif expert. Cr√©e un programme d'une semaine au format JSON strict pour mon app.
	Contraintes : [TES OBJECTIFS ICI]

	Structure JSON obligatoire :
	{
	  "1": { "type": "muscu", "title": "Titre", "desc": "Info", "exercises": [{ "name": "Exo", "sets": 3, "reps": "12", "rest": "1m" }] },
	  "2": { "type": "cardio", "title": "Titre", "desc": "Info", "exercises": [{ "name": "Course", "sets": 1, "reps": "45min", "rest": "N/A" }] },
	  "0": { "type": "rest", "title": "Repos", "desc": "Recup", "exercises": [] }
	}
	Cl√©s de "0" (Dimanche) √† "6" (Samedi). Type: "muscu", "cardio", "rest".
	IMPORTANT: Renvoie SEULEMENT le JSON brut, sans texte autour.`;

		navigator.clipboard.writeText(promptText).then(() => {
			showToast("Prompt copi√© ! Colle-le dans ChatGPT");
		}).catch(err => {
			console.error('Erreur copie', err);
		});
	}

    function renderHistory() {
        const list = document.getElementById('history-list');
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        if (history.length === 0) { list.innerHTML = '<div class="text-text-muted text-center py-8">Aucune s√©ance.</div>'; return; }
        let html = '';
        history.forEach((session, index) => {
            const isCardio = session.type === 'cardio'; const color = isCardio ? 'text-amber-400' : 'text-primary';
            const icon = isCardio ? 'footprints' : 'dumbbell';
            html += `<div class="bg-card p-4 rounded-xl relative group"><button onclick="deleteSession(${index})" class="absolute top-4 right-4 text-text-muted hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button><div class="flex items-center gap-3 mb-3 pb-3 border-b border-slate-700/50"><div class="bg-slate-700/50 p-2 rounded-lg"><i data-lucide="${icon}" class="w-5 h-5 ${color}"></i></div><div><div class="flex items-center gap-2"><div class="text-white font-bold text-sm">${session.date}</div><button onclick="editSessionDate(${index})" class="text-slate-500 hover:text-primary"><i data-lucide="pencil" class="w-3 h-3"></i></button></div><div class="text-[10px] text-text-muted uppercase font-bold tracking-wider">${session.title.split(':')[1] || session.title}</div></div></div><ul class="text-sm space-y-2">`;
            session.exercises.forEach(ex => { let disp = isCardio ? `<span class="text-amber-300 font-bold">${ex.val1}km</span>` : `<span class="bg-slate-700 px-2 rounded text-xs border border-slate-600">${ex.val1}kg x ${ex.val2}</span>`; html += `<li class="flex justify-between items-center text-slate-300"><span class="truncate pr-4">${ex.name}</span>${disp}</li>`; });
            html += `</ul></div>`;
        });
        list.innerHTML = html; lucide.createIcons();
    }

    function openCalc(weightVal) {
        if(!weightVal) { showToast("Poids manquant", true); return; }
        document.getElementById('calc-target').innerText = parseFloat(weightVal.replace(',','.'));
        document.getElementById('calc-modal').style.display = 'flex';
        let remainder = (parseFloat(weightVal.replace(',','.')) - 20) / 2;
        const div = document.getElementById('calc-result'); div.innerHTML = '';
        if (remainder <= 0) { div.innerHTML = '<span class="text-slate-400 text-sm">Juste la barre (20kg)</span>'; return; }
        [20, 15, 10, 5, 2.5, 1.25].forEach(p => { while (remainder >= p) { div.innerHTML += `<div class="plate plate-${p.toString().replace('.','-')}">${p}</div>`; remainder -= p; remainder = Math.round(remainder * 100) / 100; } });
    }
    function closeCalc() { document.getElementById('calc-modal').style.display = 'none'; }
    function showToast(message, isError = false) { const toast = document.getElementById("toast"); document.getElementById("toast-msg").innerText = message; toast.className = isError ? "error show" : "show"; if(appSettings.vibe && navigator.vibrate) navigator.vibrate(50); setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000); }
    function fillInputs(index, val1, val2) { document.getElementById(`val1_${index}`).value = val1; document.getElementById(`val2_${index}`).value = val2; showToast("Recopi√© !"); }
    function parseRestToSeconds(restStr) { if(!restStr) return 60; const match = restStr.match(/\d+/); return match ? parseInt(match[0]) * 60 : 90; }
    
    let activeTimerInterval = null;
    function startTimer(btn, duration) {
        if(activeTimerInterval) clearInterval(activeTimerInterval);
        document.querySelectorAll('.timer-btn').forEach(b => { b.classList.remove('active'); b.innerHTML = '<i data-lucide="timer" class="w-3 h-3"></i> ' + b.innerText.split(' ').pop(); lucide.createIcons(); });
        let timeLeft = duration; btn.classList.add('active');
        const updateTimer = () => {
            const min = Math.floor(timeLeft / 60); const sec = timeLeft % 60;
            btn.innerHTML = `<i data-lucide="hourglass" class="w-3 h-3"></i> ${min}:${sec < 10 ? '0'+sec : sec}`; lucide.createIcons();
            if (timeLeft <= 0) { clearInterval(activeTimerInterval); btn.classList.remove('active'); btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> Termin√©!`; lucide.createIcons(); if(appSettings.sound) document.getElementById('timer-sound').play().catch(() => {}); if(appSettings.vibe && navigator.vibrate) navigator.vibrate([200, 100, 200]); }
            timeLeft--;
        };
        updateTimer(); activeTimerInterval = setInterval(updateTimer, 1000);
    }


	// --- LOGIQUE √âDITEUR DE PROGRAMME ---

    // Initialisation du menu d√©roulant de l'√©diteur
    const daysLabels = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
    const editSelector = document.getElementById('edit-day-selector');
    daysLabels.forEach((day, index) => {
        let option = document.createElement('option');
        option.value = index;
        option.text = day;
        editSelector.add(option);
    });

    // Variable tampon pour l'√©dition en cours
    let editingDayIndex = 0;

    function loadDayEditor(dayIndex) {
        editingDayIndex = parseInt(dayIndex);
        const dayData = activeProgram[dayIndex];
        const container = document.getElementById('editor-content');
        const isCardio = dayData.type === 'cardio';
        
        let exercisesHtml = '';
        dayData.exercises.forEach((ex, i) => {
            let inputsHtml = '';

            if (isCardio) {
                // --- MODE CARDIO : Juste Nom + Objectif ---
                inputsHtml = `
                <div class="grid grid-cols-1 gap-2 mb-2">
                    <input type="text" class="input-dark text-sm font-bold" value="${ex.name}" placeholder="Nom (ex: Course)" id="ex-name-${i}">
                </div>
                <div>
                    <input type="text" class="input-dark text-xs text-center border-amber-900/50 text-amber-100" value="${ex.reps}" placeholder="Objectif (ex: 10km ou 45min)" id="ex-reps-${i}">
                    <input type="hidden" value="1" id="ex-sets-${i}">
                    <input type="hidden" value="N/A" id="ex-rest-${i}">
                </div>`;
            } else {
                // --- MODE MUSCU : Nom + S√©ries + Reps + Repos ---
                inputsHtml = `
                <div class="grid grid-cols-1 gap-2 mb-2">
                    <input type="text" class="input-dark text-sm font-bold" value="${ex.name}" placeholder="Nom de l'exercice" id="ex-name-${i}">
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" class="input-dark text-xs text-center" value="${ex.sets}" placeholder="S√©ries" id="ex-sets-${i}">
                    <input type="text" class="input-dark text-xs text-center" value="${ex.reps}" placeholder="Reps" id="ex-reps-${i}">
                    <input type="text" class="input-dark text-xs text-center" value="${ex.rest}" placeholder="Repos" id="ex-rest-${i}">
                </div>`;
            }

            exercisesHtml += `
            <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 relative group mb-2">
                <button onclick="removeExercise(${i})" class="absolute top-2 right-2 text-slate-500 hover:text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button>
                ${inputsHtml}
            </div>`;
        });

        const html = `
            <div class="card">
                <label class="text-[10px] text-text-muted uppercase font-bold mb-1">Type de s√©ance</label>
                <select id="edit-type" class="input-dark mb-3" onchange="updateDayTypeStyle(this.value); syncCurrentDayForm(); loadDayEditor(${editingDayIndex});">
                    <option value="muscu" ${dayData.type === 'muscu' ? 'selected' : ''}>Musculation</option>
                    <option value="cardio" ${dayData.type === 'cardio' ? 'selected' : ''}>Cardio / Running</option>
                    <option value="rest" ${dayData.type === 'rest' ? 'selected' : ''}>Repos</option>
                </select>

                <label class="text-[10px] text-text-muted uppercase font-bold mb-1">Titre du jour</label>
                <input type="text" id="edit-title" class="input-dark mb-3" value="${dayData.title}">

                <label class="text-[10px] text-text-muted uppercase font-bold mb-1">Description / Focus</label>
                <input type="text" id="edit-desc" class="input-dark" value="${dayData.desc}">
            </div>

            <div id="exercises-list-container" class="${dayData.type === 'rest' ? 'hidden' : ''}">
                <div class="flex justify-between items-center mb-2 px-1">
                    <label class="text-[10px] text-text-muted uppercase font-bold">
                        ${isCardio ? 'Liste des activit√©s' : 'Exercices'}
                    </label>
                    <button onclick="addExercise()" class="text-xs text-primary font-bold flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Ajouter</button>
                </div>
                <div id="exercises-list">
                    ${exercisesHtml}
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        lucide.createIcons();
    }

    function updateDayTypeStyle(type) {
        const listContainer = document.getElementById('exercises-list-container');
        if(type === 'rest') listContainer.classList.add('hidden');
        else listContainer.classList.remove('hidden');
    }

    // Sauvegarde temporaire des champs dans l'objet en m√©moire avant ajout/suppression
    function syncCurrentDayForm() {
        const dayData = activeProgram[editingDayIndex];
        dayData.type = document.getElementById('edit-type').value;
        dayData.title = document.getElementById('edit-title').value;
        dayData.desc = document.getElementById('edit-desc').value;
        
        // R√©cup√©ration des exercices
        const newExercises = [];
        const exContainer = document.getElementById('exercises-list');
        // On compte combien d'exercices sont affich√©s
        const count = exContainer.children.length;
        
        for(let i=0; i<count; i++) {
            // Attention: les IDs peuvent ne pas √™tre s√©quentiels si on supprime, 
            // mais ici on reconstruit tout √† chaque fois donc on peut scanner le DOM ou l'objet.
            // M√©thode simple : on relit les inputs pr√©sents
            const nameInput = document.getElementById(`ex-name-${i}`);
            if(nameInput) {
                 newExercises.push({
                    name: nameInput.value,
                    sets: parseInt(document.getElementById(`ex-sets-${i}`).value) || 0,
                    reps: document.getElementById(`ex-reps-${i}`).value,
                    rest: document.getElementById(`ex-rest-${i}`).value
                });
            }
        }
        dayData.exercises = newExercises;
    }

    function addExercise() {
        syncCurrentDayForm();
        activeProgram[editingDayIndex].exercises.push({ name: '', sets: 3, reps: '10', rest: '1m30' });
        loadDayEditor(editingDayIndex);
    }

    function removeExercise(index) {
        syncCurrentDayForm();
        activeProgram[editingDayIndex].exercises.splice(index, 1);
        loadDayEditor(editingDayIndex);
    }

    function saveCustomProgram() {
        syncCurrentDayForm(); // Sauvegarder l'√©tat actuel
        localStorage.setItem('gym_tracker_program', JSON.stringify(activeProgram));
        showToast("Programme sauvegard√© !");
        
        // Recharger la vue principale si on est sur le jour modifi√©
        if (currentDayIndex === editingDayIndex) {
            loadDailyView(currentDayIndex);
        }
        // Mettre √† jour le s√©lecteur principal
        updateMainSelector();
    }

    function resetProgram() {
        if(confirm("R√©initialiser le programme par d√©faut ?")) {
            activeProgram = JSON.parse(JSON.stringify(defaultProgram));
            localStorage.removeItem('gym_tracker_program');
            loadDayEditor(editingDayIndex);
            updateMainSelector();
            loadDailyView(currentDayIndex);
            showToast("Programme r√©tabli.");
        }
    }

    function updateMainSelector() {
        const mainSelector = document.getElementById('day-selector');
        mainSelector.innerHTML = '';
        daysLabels.forEach((day, index) => {
            let option = document.createElement('option');
            option.value = index;
            option.text = activeProgram[index].title;
            if(index === currentDayIndex) option.selected = true;
            mainSelector.add(option);
        });
    }

	


    function deleteSession(index) { if(confirm("Supprimer ?")) { let h = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]'); h.splice(index, 1); localStorage.setItem('gym_tracker_data_v2', JSON.stringify(h)); renderHistory(); renderStats(); } }
    function exportData() { const data = { history: JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]'), water: JSON.parse(localStorage.getItem('gym_tracker_water') || '[]'), settings: appSettings }; const blob = new Blob([JSON.stringify(data)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `gym_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = e => { try { const data = JSON.parse(e.target.result); if(data.history) localStorage.setItem('gym_tracker_data_v2', JSON.stringify(data.history)); if(data.water) localStorage.setItem('gym_tracker_water', JSON.stringify(data.water)); if(data.settings) { localStorage.setItem('gym_tracker_settings', JSON.stringify(data.settings)); loadSettings(); } showToast("Succ√®s !"); setTimeout(() => location.reload(), 1000); } catch(err) { showToast("Erreur", true); } }; reader.readAsText(file); }
    function clearData() { if(confirm("Tout effacer ?")) { localStorage.clear(); location.reload(); } }
	
	
	// --- 9. GESTION AVANC√âE DES PROGRAMMES (IMPORT/EXPORT/BIBLIOTH√àQUE) ---

    // A. Export Fichier JSON
    function exportProgramJSON() {
        const dataStr = JSON.stringify(activeProgram, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `programme_gymrun_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast("Programme export√© !");
    }

    // B. Import Fichier JSON
    function importProgramJSON(input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                // V√©rification sommaire de la structure
                if (json[0] && json[0].exercises) {
                    activeProgram = json;
                    localStorage.setItem('gym_tracker_program', JSON.stringify(activeProgram));
                    
                    // Rafra√Æchir l'interface
                    loadDailyView(currentDayIndex);
                    loadDayEditor(editingDayIndex || 0); // Recharger l'√©diteur si ouvert
                    updateMainSelector(); // Mettre √† jour le titre des jours dans la home
                    
                    showToast("Programme import√© avec succ√®s !");
                } else {
                    showToast("Format invalide", true);
                }
            } catch (err) {
                console.error(err);
                showToast("Erreur de lecture du fichier", true);
            }
        };
        reader.readAsText(file);
        // Reset input pour permettre de r√©importer le m√™me fichier
        input.value = '';
    }

    // C. Biblioth√®que Locale (Sauvegarde interne)
    function getLibrary() {
        return JSON.parse(localStorage.getItem('gym_tracker_program_library') || '{}');
    }

    function saveProgramToLibrary() {
        const name = document.getElementById('prog-save-name').value.trim();
        if (!name) { showToast("Nom requis !", true); return; }
        
        const lib = getLibrary();
        lib[name] = JSON.parse(JSON.stringify(activeProgram)); // Copie propre
        localStorage.setItem('gym_tracker_program_library', JSON.stringify(lib));
        
        updateLibrarySelector();
        document.getElementById('prog-save-name').value = '';
        showToast(`"${name}" sauvegard√© !`);
    }

    function loadProgramFromLibrary() {
        const name = document.getElementById('library-selector').value;
        if (!name) return;
        
        if(confirm(`Remplacer la semaine actuelle par "${name}" ?`)) {
            const lib = getLibrary();
            if (lib[name]) {
                activeProgram = lib[name];
                localStorage.setItem('gym_tracker_program', JSON.stringify(activeProgram));
                
                // Refresh UI
                loadDailyView(currentDayIndex);
                if(document.getElementById('view-editor').classList.contains('active')) {
                   loadDayEditor(editingDayIndex || 0);
                }
                updateMainSelector();
                showToast("Programme charg√© !");
            }
        }
    }

    function deleteProgramFromLibrary() {
        const name = document.getElementById('library-selector').value;
        if (!name) return;
        
        if(confirm(`Supprimer d√©finitivement "${name}" de la biblioth√®que ?`)) {
            const lib = getLibrary();
            delete lib[name];
            localStorage.setItem('gym_tracker_program_library', JSON.stringify(lib));
            updateLibrarySelector();
            showToast("Supprim√©.");
        }
    }

    function updateLibrarySelector() {
        const selector = document.getElementById('library-selector');
        const lib = getLibrary();
        
        // Garder l'option par d√©faut
        selector.innerHTML = '<option value="">-- Choisir un programme --</option>';
        
        Object.keys(lib).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.text = name;
            selector.add(opt);
        });
    }

    // Appel initial pour remplir la liste au d√©marrage
    updateLibrarySelector();
	
	
	// --- 8. TIME TRACKER (Compteur de temps) ---
    setInterval(() => {
        // R√©cup√®re le temps actuel ou 0, ajoute 1 seconde et sauvegarde
        let total = parseInt(localStorage.getItem('gym_tracker_time_spent') || '0');
        localStorage.setItem('gym_tracker_time_spent', total + 1);
    }, 1000);
</script>
</body>
</html>
