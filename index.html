<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym & Run Coach V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* BASE & THEME */
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .p-4 { padding-bottom: 130px; }
        /* COMPONENTS */
        .card { background-color: #1e293b; border-radius: 16px; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); border: 1px solid #334155; }
        .input-dark { background-color: #0f172a; border: 1px solid #334155; color: white; padding: 0.8rem; border-radius: 12px; width: 100%; transition: 0.2s; font-size: 16px; font-weight: 600; }
        .input-dark:focus { border-color: #3b82f6; outline: none; background-color: #172033; }
        
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1rem; border-radius: 14px; font-weight: bold; width: 100%; text-align: center; cursor: pointer; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background-color: #334155; color: white; padding: 0.8rem; border-radius: 12px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; transition: background 0.2s; }
        .btn-secondary:active { background-color: #475569; }
        
        .timer-btn { background-color: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #60a5fa; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 700; }
        .timer-btn.active { background-color: #ea580c; border-color: #ea580c; color: white; animation: pulse 1.5s infinite; }
        
        .calc-btn { position: absolute; right: 12px; top: 40px; color: #94a3b8; padding: 4px; cursor: pointer; z-index: 10; }
        
        .clickable-history { cursor: pointer; border-radius: 6px; padding: 4px 8px; margin-right: 6px; display: inline-flex; align-items: center; gap: 4px; font-size: 0.7rem; border: 1px solid transparent; font-weight: 600; white-space: nowrap; }
        .clickable-history.last { background-color: rgba(59, 130, 246, 0.15); color: #93c5fd; border-color: rgba(59, 130, 246, 0.3); }
        .clickable-history.best { background-color: rgba(234, 179, 8, 0.15); color: #fde047; border-color: rgba(234, 179, 8, 0.3); }
        .clickable-history.coach { background-color: rgba(168, 85, 247, 0.15); color: #d8b4fe; border-color: rgba(168, 85, 247, 0.3); box-shadow: 0 0 10px rgba(168, 85, 247, 0.1); animation: glow 2s infinite alternate; }

        /* NAVBAR */
        .navbar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(30, 41, 59, 0.95); border-top: 1px solid #334155; display: flex; justify-content: space-around; padding: 12px 0 24px 0; z-index: 50; backdrop-filter: blur(12px); }
        .nav-item { color: #64748b; text-align: center; flex: 1; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item i { width: 24px; height: 24px; transition: 0.2s; }
        .nav-item span { font-size: 10px; font-weight: 600; }
        .nav-item.active { color: #3b82f6; }
        .nav-item.active i { transform: translateY(-2px); color: #60a5fa; }

        .page-view { display: none; opacity: 0; animation: fadeIn 0.2s forwards; }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(168, 85, 247, 0.1); } to { box-shadow: 0 0 15px rgba(168, 85, 247, 0.3); } }

        /* MODAL & TOAST */
        #calc-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .plate { display: inline-block; width: 45px; height: 45px; line-height: 41px; text-align: center; border-radius: 50%; font-weight: bold; font-size: 12px; margin: 3px; color: #1e293b; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .plate-20 { background-color: #2563eb; color: white; width: 55px; height: 55px; line-height: 51px; } 
        .plate-15 { background-color: #eab308; } .plate-10 { background-color: #16a34a; color: white; } 
        .plate-5 { background-color: #ef4444; color: white; width: 38px; height: 38px; line-height: 34px;} 
        .plate-2-5 { background-color: #1e293b; color: white; border-color: white; width: 32px; height: 32px; line-height: 28px; } 
        .plate-1-25 { background-color: #cbd5e1; width: 28px; height: 28px; line-height: 24px; font-size: 9px; }

        #toast { visibility: hidden; min-width: 250px; background-color: #10b981; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 60; left: 50%; bottom: 100px; transform: translateX(-50%); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); opacity: 0; transition: all 0.3s; font-weight: bold; }
        #toast.show { visibility: visible; opacity: 1; bottom: 110px; }
        
        /* GRAPHIQUE */
        .chart-container { height: 150px; width: 100%; display: flex; align-items: flex-end; gap: 8px; padding-top: 20px; }
        .chart-bar { flex: 1; background: linear-gradient(to top, #3b82f6, #60a5fa); border-radius: 4px 4px 0 0; position: relative; min-height: 4px; transition: height 0.5s ease; }
        .chart-bar span { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 9px; color: #94a3b8; width: 100%; text-align: center; }
        
        /* STYLE NUTRITION */
        .meal-card { border-left: 4px solid transparent; }
        .meal-card.today { border-color: #3b82f6; background-color: rgba(30, 41, 59, 0.8); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        .meal-tag { font-size: 10px; text-transform: uppercase; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
        .tag-muscu { background-color: #1e3a8a; color: #93c5fd; }
        .tag-run { background-color: #451a03; color: #fbbf24; }
        .tag-rest { background-color: #064e3b; color: #6ee7b7; }

        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1rem auto; padding-right: 2.5rem; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(234, 88, 12, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); } }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">

    <header class="flex justify-between items-center mb-6 px-1">
        <div>
            <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-300" id="header-title">Gym & Run</h1>
            <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase" id="header-subtitle">Coach AI V5</p>
        </div>
        <div class="bg-slate-800 p-2 rounded-full border border-slate-700 shadow-lg">
            <i data-lucide="brain-circuit" class="w-5 h-5 text-purple-400"></i>
        </div>
    </header>

    <div id="view-tracker" class="page-view active">
        <div class="mb-6">
            <div class="relative">
                <select id="day-selector" onchange="manualDayChange(this.value)" class="w-full bg-slate-800 text-white border border-slate-600 rounded-xl p-3.5 font-bold focus:outline-none focus:border-blue-500 shadow-lg appearance-none">
                </select>
            </div>
        </div>
        <div id="app-content"></div>
    </div>

    <div id="view-history" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="history" class="w-5 h-5 text-blue-400"></i> Historique</h2>
        <div id="history-list" class="space-y-3 pb-4"></div>
    </div>

    <div id="view-stats" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-400"></i> Performance</h2>
        <div class="grid grid-cols-2 gap-3 mb-6" id="weekly-stats"></div>
        <div class="card bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700">
            <h3 class="text-xs text-slate-400 uppercase font-bold mb-1">Volume Muscu (kg)</h3>
            <div id="volume-chart" class="chart-container"></div>
            <div class="flex justify-between text-[10px] text-slate-500 mt-2 px-1"><span>S-3</span><span>S-2</span><span>S-1</span><span>Actuel</span></div>
        </div>
    </div>

    <div id="view-nutrition" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="utensils" class="w-5 h-5 text-blue-400"></i> Plan Nutritionnel</h2>
        <div id="nutrition-list" class="space-y-3">
            </div>
    </div>

    <div id="view-settings" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4">Param√®tres</h2>
        <div class="space-y-4">
            <div class="card">
                <h3 class="font-bold text-white mb-2 flex items-center gap-2"><i data-lucide="database" class="w-4 h-4 text-blue-400"></i> Donn√©es</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportData()" class="btn-secondary text-sm"><i data-lucide="download" class="w-4 h-4"></i> Sauvegarder</button>
                    <button onclick="document.getElementById('import-file').click()" class="btn-secondary text-sm"><i data-lucide="upload" class="w-4 h-4"></i> Restaurer</button>
                </div>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
            </div>
            <div class="card border-red-900/30 bg-red-900/10">
                <button onclick="clearData()" class="w-full py-3 text-red-400 text-sm font-bold border border-red-900/50 rounded-lg hover:bg-red-900/20">Tout effacer</button>
            </div>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-item active" onclick="switchTab('tracker', this)"><i data-lucide="dumbbell"></i><span>S√©ance</span></div>
        <div class="nav-item" onclick="switchTab('history', this)"><i data-lucide="calendar-days"></i><span>Journal</span></div>
        <div class="nav-item" onclick="switchTab('stats', this)"><i data-lucide="bar-chart-2"></i><span>Stats</span></div>
        <div class="nav-item" onclick="switchTab('nutrition', this)"><i data-lucide="utensils"></i><span>Nutri</span></div>
        <div class="nav-item" onclick="switchTab('settings', this)"><i data-lucide="settings"></i><span>Outils</span></div>
    </nav>

    <div id="calc-modal" onclick="closeCalc()">
        <div class="bg-slate-900 p-6 rounded-2xl w-80 text-center border border-slate-700 shadow-2xl transform scale-100" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-white mb-2">Charger la Barre</h3>
            <p class="text-slate-400 text-sm mb-4">Objectif : <span id="calc-target" class="text-blue-400 font-bold text-lg">0</span> kg</p>
            <div id="calc-result" class="bg-slate-800 p-4 rounded-xl mb-4 min-h-[80px] flex flex-wrap justify-center items-center gap-1"></div>
            <div class="text-xs text-slate-500 mb-4">Barre olympique standard (20kg)</div>
            <button onclick="closeCalc()" class="btn-primary">Fermer</button>
        </div>
    </div>

    <div id="toast"><span id="toast-msg">Message</span></div>
    <audio id="timer-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
    // --- 1. DONN√âES DU PROGRAMME ---
    const program = {
        1: { type: 'muscu', title: 'Lundi : PUSH', desc: 'Pecs, √âpaules, Triceps',
            exercises: [
                { name: 'D√©velopp√© Couch√©', sets: 4, reps: '6-10', rest: '2-3 min' },
                { name: 'D√©velopp√© Inclin√© Halt√®res', sets: 3, reps: '8-12', rest: '2 min' },
                { name: 'D√©velopp√© Militaire', sets: 3, reps: '8-12', rest: '2 min' },
                { name: '√âl√©vations Lat√©rales', sets: 4, reps: '12-15', rest: '1m30' },
                { name: 'Extensions Triceps Poulie', sets: 3, reps: '10-15', rest: '1m30' }
            ]},
        2: { type: 'cardio', title: 'Mardi : RUNNING', desc: 'Endurance Fondamentale',
            exercises: [{ name: 'Course √† pied', sets: 1, reps: '45-60 min', rest: 'N/A' }]},
        3: { type: 'muscu', title: 'Mercredi : PULL', desc: 'Dos, Arri√®re √©paule, Biceps',
            exercises: [
                { name: 'Tractions (ou Tirage vertical)', sets: 4, reps: 'Max', rest: '2-3 min' },
                { name: 'Rowing Barre', sets: 3, reps: '8-12', rest: '2 min' },
                { name: 'Tirage Horizontal', sets: 3, reps: '10-12', rest: '1m30' },
                { name: 'Face Pulls', sets: 4, reps: '15-20', rest: '1m30' },
                { name: 'Curl Barre', sets: 3, reps: '8-12', rest: '1m30' }
            ]},
        4: { type: 'cardio', title: 'Jeudi : RUNNING', desc: 'Endurance - Hydratation ++',
            exercises: [{ name: 'Course √† pied', sets: 1, reps: '45-60 min', rest: 'N/A' }]},
        5: { type: 'muscu', title: 'Vendredi : UPPER BODY', desc: 'Volume & Rappel',
            exercises: [
                { name: 'Dips', sets: 3, reps: '8-12', rest: '2 min' },
                { name: 'Tirage Vertical Supination', sets: 3, reps: '8-12', rest: '2 min' },
                { name: '√âcart√© Poulie Vis-√†-vis', sets: 3, reps: '12-15', rest: '1m30' },
                { name: 'Curl Marteau', sets: 3, reps: '10-15', rest: '1m30' },
                { name: 'Extension Triceps T√™te', sets: 3, reps: '10-15', rest: '1m30' }
            ]},
        6: { type: 'cardio', title: 'Samedi : RUNNING', desc: 'Sortie Longue / Plaisir',
            exercises: [{ name: 'Course √† pied', sets: 1, reps: 'Libre', rest: 'N/A' }]},
        0: { type: 'rest', title: 'Dimanche : REPOS', desc: 'R√©cup√©ration - Low Carb', exercises: [] }
    };

    // --- 2. INITIALISATION ---
    const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
    let currentDayIndex = new Date().getDay();

    const selector = document.getElementById('day-selector');
    days.forEach((day, index) => {
        let option = document.createElement('option');
        option.value = index;
        option.text = program[index].title;
        if(index === currentDayIndex) option.selected = true;
        selector.add(option);
    });

    lucide.createIcons();
    loadDailyView(currentDayIndex);

    // --- 3. NAVIGATION ---
    function switchTab(tabId, element) {
        document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        if(tabId === 'history') renderHistory();
        if(tabId === 'stats') { renderWeeklyStats(); renderVolumeChart(); }
        if(tabId === 'nutrition') { renderNutrition(); }
        
        const titles = { 'tracker': 'Gym & Run', 'history': 'Journal', 'stats': 'Statistiques', 'nutrition': 'Coach Nutri', 'settings': 'Outils' };
        document.getElementById('header-title').innerText = titles[tabId];
    }

    function manualDayChange(val) {
        currentDayIndex = parseInt(val);
        loadDailyView(currentDayIndex);
    }

    // --- 4. CORE: TRACKER & COACHING ---
    function getCoachAdvice(lastData, targetRepString) {
        if(!lastData) return null;
        let maxTarget = 12; 
        const rangeMatch = targetRepString.match(/-(\d+)/);
        if(rangeMatch) maxTarget = parseInt(rangeMatch[1]);
        else if (targetRepString.includes('Max')) maxTarget = 20;

        const lastWeight = parseFloat(lastData.val1.replace(',','.'));
        const lastReps = parseInt(lastData.val2.split(',')[0]);

        if(isNaN(lastWeight) || isNaN(lastReps)) return null;

        if (lastReps >= maxTarget) {
            return { type: 'weight', val1: lastWeight + 2.5, val2: targetRepString, msg: `+2.5kg !` };
        } else {
            return { type: 'reps', val1: lastWeight, val2: lastReps + 1, msg: `Vise ${lastReps + 1} reps` };
        }
    }

    function loadDailyView(dayIndex) {
        const contentDiv = document.getElementById('app-content');
        const dayPlan = program[dayIndex];

        if (dayPlan.type === 'rest') {
            contentDiv.innerHTML = `
                <div class="card text-center py-12 border-t-4 border-emerald-500 bg-gradient-to-b from-emerald-900/20 to-slate-900">
                    <div class="bg-emerald-900/30 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border border-emerald-500/30">
                        <i data-lucide="coffee" class="w-10 h-10 text-emerald-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Repos</h2>
                    <p class="text-slate-400 mt-2 text-sm">${dayPlan.desc}</p>
                    <div class="mt-8 bg-slate-800/80 p-5 rounded-xl text-left text-sm border border-slate-700">
                        <p class="text-emerald-400 font-bold mb-2 flex items-center gap-2 text-xs uppercase tracking-wide"><i data-lucide="leaf" class="w-4 h-4"></i> Nutrition</p>
                        <p class="text-slate-300">Moins de glucides, plus de l√©gumes et bons lipides (avocat, noix).</p>
                    </div>
                </div>`;
            lucide.createIcons();
            return;
        }

        const isCardio = dayPlan.type === 'cardio';
        let html = `<form id="workout-form" onsubmit="event.preventDefault();">`;

        dayPlan.exercises.forEach((exo, index) => {
            const historyData = getHistoryData(exo.name);
            const lastData = historyData.last;
            
            let historyHTML = '';
            if (!lastData) {
                historyHTML = `<div class="text-xs text-slate-500 mb-3 italic flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> Pas d'historique</div>`;
            } else {
                const lastText = isCardio ? `${lastData.val1}km / ${lastData.val2}` : `${lastData.val1}kg x ${lastData.val2}`;
                
                let coachHTML = '';
                if(!isCardio) {
                    const advice = getCoachAdvice(lastData, exo.reps);
                    if(advice) {
                        coachHTML = `
                            <div onclick="fillInputs(${index}, '${advice.val1}', '${advice.val2}')" 
                                 class="clickable-history coach" title="Appliquer le conseil">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> Coach: <strong>${advice.msg}</strong>
                            </div>`;
                    }
                }

                historyHTML = `
                    <div class="flex gap-2 mb-3 overflow-x-auto no-scrollbar">
                        <div onclick="fillInputs(${index}, '${lastData.val1}', '${lastData.val2}')" class="clickable-history last" title="Copier dernier">
                            <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Last: <strong>${lastText}</strong>
                        </div>
                        ${coachHTML}
                    </div>`;
            }

            let actionBtn = '';
            if (!isCardio && exo.rest !== 'N/A') {
                const seconds = parseRestToSeconds(exo.rest);
                actionBtn = `<button type="button" class="timer-btn" onclick="startTimer(this, ${seconds})"><i data-lucide="timer" class="w-3 h-3"></i> ${exo.rest}</button>`;
            }

            let calcBtn = '';
            if (!isCardio && !exo.name.includes('Halt√®res') && !exo.name.includes('Poulie')) {
                calcBtn = `<i data-lucide="scale" class="w-4 h-4 calc-btn" onclick="openCalc(document.getElementById('val1_${index}').value)"></i>`;
            }

            const label1 = isCardio ? "Distance (km)" : "Charge (kg)";
            const place1 = isCardio ? "Ex: 8.5" : "Ex: 60";
            const label2 = isCardio ? "Temps (min)" : "Reps";
            const place2 = isCardio ? "Ex: 45:30" : "Ex: 10,10,9";

            html += `
                <div class="card relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg text-blue-100 flex items-center gap-2 leading-tight">${exo.name}</h3>
                            <div class="text-xs text-slate-400 mt-1 mb-2 font-medium flex items-center gap-2">
                                <span class="bg-slate-700/50 px-1.5 py-0.5 rounded text-slate-300 border border-slate-600">${exo.sets} s√©ries</span>
                                <span class="text-slate-600">‚Ä¢</span>
                                <span>${exo.reps} reps</span>
                            </div>
                        </div>
                        ${actionBtn}
                    </div>
                    ${historyHTML}
                    <div class="grid grid-cols-2 gap-3 relative">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1.5 block ml-1">${label1}</label>
                            <div class="relative">
                                <input type="number" id="val1_${index}" name="val1_${index}" class="input-dark font-mono text-center text-blue-100 pl-2 pr-6" placeholder="${place1}" inputmode="decimal">
                                ${calcBtn}
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1.5 block ml-1">${label2}</label>
                            <input type="text" id="val2_${index}" name="val2_${index}" class="input-dark font-mono text-center text-blue-100" placeholder="${place2}" inputmode="${isCardio ? 'text' : 'text'}">
                        </div>
                    </div>
                </div>`;
        });

        html += `
            <div class="card">
                <label class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-2 block flex items-center gap-2"><i data-lucide="sticky-note" class="w-3 h-3"></i> Notes</label>
                <textarea name="notes" class="input-dark text-sm min-h-[60px] font-normal text-slate-300" placeholder="Sensations..."></textarea>
            </div>
            <button type="button" onclick="saveWorkout(${dayIndex})" class="btn-primary mb-8 text-lg shadow-blue-900/20 shadow-xl">Valider la s√©ance</button>
            </form>`;

        contentDiv.innerHTML = html;
        lucide.createIcons();
    }

    // --- 5. NOUVELLE FONCTION NUTRITION ---
    function renderNutrition() {
        const list = document.getElementById('nutrition-list');
        const today = new Date().getDay();
        
        // Configuration des jours
        const nutriPlan = [
            { day: 1, type: 'muscu', title: 'Lundi (Muscu)' },
            { day: 2, type: 'run', title: 'Mardi (Run)' },
            { day: 3, type: 'muscu', title: 'Mercredi (Muscu)' },
            { day: 4, type: 'run', title: 'Jeudi (Run)' },
            { day: 5, type: 'muscu', title: 'Vendredi (Muscu)' },
            { day: 6, type: 'run', title: 'Samedi (Run)' },
            { day: 0, type: 'rest', title: 'Dimanche (Repos)' }
        ];

        let html = '';
        
        // On r√©organise pour commencer par Lundi
        const sortedPlan = [...nutriPlan.slice(0, 6), nutriPlan[6]]; // [Lun...Sam] + [Dim]
        // Petite correction : nutriPlan[0] est Lundi (index 0 dans le tableau tri√©)
        
        nutriPlan.forEach(item => {
            const isToday = item.day === today;
            const activeClass = isToday ? 'today' : 'opacity-70 grayscale hover:grayscale-0 transition-all';
            const icon = item.type === 'muscu' ? 'dumbbell' : (item.type === 'run' ? 'footprints' : 'coffee');
            
            let tag = '';
            let content = '';

            if (item.type === 'muscu') {
                tag = '<span class="meal-tag tag-muscu">Force</span>';
                content = `
                    <ul class="text-xs text-slate-300 space-y-1 list-disc pl-4 mt-2">
                        <li><strong>Matin:</strong> Avoine + ≈íufs (Glucides lents).</li>
                        <li><strong>Midi:</strong> Riz/P√¢tes + Viande (Energie).</li>
                        <li><strong>Post-S√©ance:</strong> Whey ou Repas riche en prot√©ines.</li>
                        <li><strong>D√Æner:</strong> F√©culents mod√©r√©s + L√©gumes.</li>
                    </ul>`;
            } else if (item.type === 'run') {
                tag = '<span class="meal-tag tag-run">Cardio</span>';
                content = `
                    <ul class="text-xs text-slate-300 space-y-1 list-disc pl-4 mt-2">
                        <li><strong>Hydratation:</strong> Bois +500ml d'eau.</li>
                        <li><strong>Midi:</strong> Glucides complexes (Quinoa/Lentilles).</li>
                        <li><strong>Avant course:</strong> Banane ou poign√©e d'amandes.</li>
                        <li><strong>D√Æner:</strong> L√©ger (Soupe + Poisson).</li>
                    </ul>`;
            } else {
                tag = '<span class="meal-tag tag-rest">Repos</span>';
                content = `
                    <ul class="text-xs text-slate-300 space-y-1 list-disc pl-4 mt-2">
                        <li><strong>Objectif:</strong> R√©cup√©ration (Low Carb).</li>
                        <li><strong>Assiette:</strong> 50% L√©gumes, 25% Prot√©ines, 25% Gras.</li>
                        <li><strong>Focus:</strong> Avocat, Saumon, Noix, Huile d'olive.</li>
                        <li><strong>Soir:</strong> Z√©ro f√©culents si possible.</li>
                    </ul>`;
            }

            html += `
                <div class="card meal-card ${activeClass} mb-3">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-2">
                            <i data-lucide="${icon}" class="w-4 h-4 text-slate-400"></i>
                            <h3 class="font-bold text-white text-sm">${item.title}</h3>
                        </div>
                        ${tag}
                    </div>
                    ${content}
                </div>
            `;
        });

        list.innerHTML = html;
        lucide.createIcons();
        
        // Auto-scroll vers le jour actuel si besoin (optionnel)
        if(document.querySelector('.today')) {
            setTimeout(() => document.querySelector('.today').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        }
    }

    // --- 6. STATS & UTILS ---
    function renderVolumeChart() {
        const container = document.getElementById('volume-chart');
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        const weeks = [0,0,0,0];
        const now = new Date();
        const oneWeek = 7 * 24 * 60 * 60 * 1000;
        history.forEach(session => {
            if(session.type !== 'muscu') return;
            const diff = now.getTime() - session.timestamp;
            const weekIndex = 3 - Math.floor(diff / oneWeek);
            if(weekIndex >= 0 && weekIndex <= 3) {
                let sessionVol = 0;
                session.exercises.forEach(ex => {
                    const w = parseFloat(ex.val1);
                    const rStr = ex.val2.split(',').map(s => parseInt(s));
                    const totalReps = rStr.reduce((a,b) => a + (isNaN(b)?0:b), 0);
                    if(!isNaN(w)) sessionVol += w * totalReps;
                });
                weeks[weekIndex] += sessionVol;
            }
        });
        const maxVol = Math.max(...weeks, 1);
        let html = '';
        weeks.forEach((vol, i) => {
            const heightPct = Math.round((vol / maxVol) * 100);
            const color = i === 3 ? 'bg-blue-500' : 'bg-slate-700';
            html += `<div class="chart-bar ${color}" style="height: ${heightPct}%"><span class="text-[9px]">${(vol/1000).toFixed(1)}k</span></div>`;
        });
        container.innerHTML = html;
    }

    function openCalc(weightVal) {
        if(!weightVal) { showToast("Poids manquant", true); return; }
        const weight = parseFloat(weightVal.replace(',','.'));
        document.getElementById('calc-target').innerText = weight;
        document.getElementById('calc-modal').style.display = 'flex';
        let remainder = (weight - 20) / 2;
        const div = document.getElementById('calc-result');
        div.innerHTML = '';
        if (remainder <= 0) { div.innerHTML = '<span class="text-slate-400 text-sm">Juste la barre (20kg)</span>'; return; }
        [20, 15, 10, 5, 2.5, 1.25].forEach(p => {
            while (remainder >= p) {
                div.innerHTML += `<div class="plate plate-${p.toString().replace('.','-')}">${p}</div>`;
                remainder -= p; remainder = Math.round(remainder * 100) / 100;
            }
        });
    }
    function closeCalc() { document.getElementById('calc-modal').style.display = 'none'; }

    function getHistoryData(exoName) {
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        let last = null, best = null;
        for (let session of history) {
            const found = session.exercises.find(e => e.name === exoName || e.name.includes(exoName));
            if (found) {
                if(!last) last = found;
                const val = parseFloat(found.val1.replace(',','.'));
                if (!isNaN(val) && (!best || val > parseFloat(best.val1.replace(',','.')))) best = found;
            }
        }
        return { last, best };
    }

    function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        document.getElementById("toast-msg").innerText = message;
        toast.className = isError ? "error show" : "show";
        if(navigator.vibrate) navigator.vibrate(isError ? [50, 50, 50] : 50);
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }

    function fillInputs(index, val1, val2) {
        document.getElementById(`val1_${index}`).value = val1;
        document.getElementById(`val2_${index}`).value = val2;
        showToast("Recopi√© !");
    }

    let activeTimerInterval = null;
    function parseRestToSeconds(restStr) {
        if(!restStr) return 60;
        const match = restStr.match(/\d+/);
        return match ? parseInt(match[0]) * 60 : 90;
    }

    function startTimer(btn, duration) {
        if(activeTimerInterval) clearInterval(activeTimerInterval);
        document.querySelectorAll('.timer-btn').forEach(b => {
            b.classList.remove('active');
            b.innerHTML = '<i data-lucide="timer" class="w-3 h-3"></i> ' + b.innerText.split(' ').pop();
            lucide.createIcons();
        });
        let timeLeft = duration;
        btn.classList.add('active');
        const updateTimer = () => {
            const min = Math.floor(timeLeft / 60);
            const sec = timeLeft % 60;
            btn.innerHTML = `<i data-lucide="hourglass" class="w-3 h-3"></i> ${min}:${sec < 10 ? '0'+sec : sec}`;
            lucide.createIcons();
            if (timeLeft <= 0) {
                clearInterval(activeTimerInterval);
                btn.classList.remove('active');
                btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> Termin√©!`;
                lucide.createIcons();
                document.getElementById('timer-sound').play().catch(() => {});
                if("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
            }
            timeLeft--;
        };
        updateTimer();
        activeTimerInterval = setInterval(updateTimer, 1000);
    }

    // --- 7. SAUVEGARDE & SYSTEME ---
    function saveWorkout(dayIndex) {
        const form = document.getElementById('workout-form');
        const dayPlan = program[dayIndex];
        const date = new Date().toLocaleDateString('fr-FR');
        let sessionData = { date: date, timestamp: new Date().getTime(), title: dayPlan.title, type: dayPlan.type, notes: form.notes ? form.notes.value : "", exercises: [] };
        dayPlan.exercises.forEach((exo, index) => {
            const val1 = form[`val1_${index}`].value;
            const val2 = form[`val2_${index}`].value;
            if(val1 || val2) sessionData.exercises.push({ name: exo.name, val1: val1 || '-', val2: val2 || '-' });
        });
        if (sessionData.exercises.length === 0) { showToast("Vide !", true); return; }
        let history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        history.unshift(sessionData);
        localStorage.setItem('gym_tracker_data_v2', JSON.stringify(history));
        showToast("Valid√© ! üî•"); form.reset(); loadDailyView(dayIndex);
    }

    function renderWeeklyStats() {
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        const statsDiv = document.getElementById('weekly-stats');
        const now = new Date(); const diff = now.getDate() - now.getDay() + (now.getDay() == 0 ? -6 : 1);
        const monday = new Date(now.setDate(diff)).setHours(0,0,0,0);
        let gymCount = 0, runKm = 0;
        history.forEach(session => {
            const parts = session.date.split('/'); const time = new Date(parts[2], parts[1]-1, parts[0]).getTime();
            if(time >= monday) {
                if(session.type === 'muscu') gymCount++;
                else if (session.type === 'cardio') session.exercises.forEach(ex => { const km = parseFloat(ex.val1.replace(',','.')); if(!isNaN(km)) runKm += km; });
            }
        });
        statsDiv.innerHTML = `
            <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 text-center"><div class="text-[10px] text-slate-400 uppercase font-bold mb-1">Muscu (Hebdo)</div><div class="text-3xl font-black text-white">${gymCount}</div></div>
            <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 text-center"><div class="text-[10px] text-slate-400 uppercase font-bold mb-1">Running (Hebdo)</div><div class="text-3xl font-black text-amber-400">${runKm.toFixed(1)} <span class="text-sm">km</span></div></div>`;
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        if (history.length === 0) { list.innerHTML = '<div class="text-slate-500 text-center py-8">Aucune s√©ance.</div>'; return; }
        let html = '';
        history.forEach((session, index) => {
            const isCardio = session.type === 'cardio';
            const color = isCardio ? 'text-amber-400' : 'text-blue-400';
            html += `
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 relative group">
                    <button onclick="deleteSession(${index})" class="absolute top-4 right-4 text-slate-600 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <div class="flex items-center gap-3 mb-3 pb-3 border-b border-slate-700/50">
                        <div class="bg-slate-700/50 p-2 rounded-lg"><i data-lucide="${isCardio ? 'footprints' : 'dumbbell'}" class="w-5 h-5 ${color}"></i></div>
                        <div><div class="text-white font-bold text-sm">${session.date}</div><div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">${session.title.split(':')[1] || session.title}</div></div>
                    </div>
                    <ul class="text-sm space-y-2">`;
            session.exercises.forEach(ex => {
                let disp = isCardio ? `<span class="text-amber-300 font-bold">${ex.val1}km</span>` : `<span class="bg-slate-700 px-2 rounded text-xs border border-slate-600">${ex.val1}kg x ${ex.val2}</span>`;
                html += `<li class="flex justify-between items-center text-slate-300"><span class="truncate pr-4">${ex.name}</span>${disp}</li>`;
            });
            html += `</ul></div>`;
        });
        list.innerHTML = html;
        lucide.createIcons();
    }

    function deleteSession(index) {
        if(confirm("Supprimer ?")) {
            let h = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]'); h.splice(index, 1);
            localStorage.setItem('gym_tracker_data_v2', JSON.stringify(h));
            renderHistory(); renderWeeklyStats(); renderVolumeChart();
        }
    }

    function exportData() {
        const data = { history: JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]') };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `gym_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function importData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                if(data.history) localStorage.setItem('gym_tracker_data_v2', JSON.stringify(data.history));
                else if(Array.isArray(data)) localStorage.setItem('gym_tracker_data_v2', JSON.stringify(data));
                showToast("Succ√®s !"); setTimeout(() => location.reload(), 1000);
            } catch(err) { showToast("Erreur", true); }
        };
        reader.readAsText(file);
    }

    function clearData() {
        if(confirm("Tout effacer ?")) { localStorage.clear(); location.reload(); }
    }
</script>
</body>
</html>
