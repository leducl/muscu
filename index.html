<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym & Run Coach V9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- VARIABLES DE THEME (Modifiables par JS) --- */
        :root {
            --primary: #3b82f6;       /* Blue-500 */
            --primary-dark: #1d4ed8;  /* Blue-700 */
            --primary-light: #60a5fa; /* Blue-400 */
            --bg-card: #1e293b;
            --text-main: #e2e8f0;
        }

        /* BASE */
        body { background-color: #0f172a; color: var(--text-main); font-family: 'Segoe UI', system-ui, sans-serif; padding-bottom: 130px; -webkit-tap-highlight-color: transparent; }
        
        /* COMPONENTS DYNAMIQUES */
        .card { background-color: var(--bg-card); border-radius: 16px; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); border: 1px solid #334155; }
        
        .input-dark { background-color: #0f172a; border: 1px solid #334155; color: white; padding: 0.8rem; border-radius: 12px; width: 100%; transition: 0.2s; font-size: 16px; font-weight: 600; }
        .input-dark:focus { border-color: var(--primary); outline: none; background-color: #172033; }
        
        .btn-primary { background: var(--primary); color: white; padding: 1rem; border-radius: 14px; font-weight: bold; width: 100%; text-align: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0, 0.3); transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-secondary { background-color: #334155; color: white; padding: 0.8rem; border-radius: 12px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; transition: background 0.2s; }
        .btn-secondary:active { background-color: #475569; }
        
        .timer-btn { background-color: rgba(255,255,255, 0.05); border: 1px solid var(--primary); color: var(--primary-light); padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 700; }
        .timer-btn.active { background-color: #ea580c; border-color: #ea580c; color: white; animation: pulse 1.5s infinite; }
        
        .calc-btn { position: absolute; right: 12px; top: 40px; color: #94a3b8; padding: 4px; cursor: pointer; z-index: 10; }
        
        /* HISTORIQUE */
        .clickable-history { cursor: pointer; border-radius: 6px; padding: 4px 8px; margin-right: 6px; display: inline-flex; align-items: center; gap: 4px; font-size: 0.7rem; border: 1px solid transparent; font-weight: 600; white-space: nowrap; }
        .clickable-history.last { background-color: rgba(255,255,255,0.05); color: var(--primary-light); border-color: var(--primary); }
        .clickable-history.best { background-color: rgba(234, 179, 8, 0.15); color: #fde047; border-color: rgba(234, 179, 8, 0.3); }
        .clickable-history.coach { background-color: rgba(168, 85, 247, 0.15); color: #d8b4fe; border-color: rgba(168, 85, 247, 0.3); box-shadow: 0 0 10px rgba(168, 85, 247, 0.1); animation: glow 2s infinite alternate; }

        /* NAVBAR */
        .navbar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(30, 41, 59, 0.95); border-top: 1px solid #334155; display: flex; justify-content: space-around; padding: 12px 0 24px 0; z-index: 50; backdrop-filter: blur(12px); }
        .nav-item { color: #64748b; text-align: center; flex: 1; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item i { width: 24px; height: 24px; transition: 0.2s; }
        .nav-item span { font-size: 10px; font-weight: 600; }
        .nav-item.active { color: var(--primary-light); }
        .nav-item.active i { transform: translateY(-2px); color: var(--primary); }

        /* PAGES LOGIC */
        .page-view { display: none; opacity: 0; animation: fadeIn 0.2s forwards; }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(168, 85, 247, 0.1); } to { box-shadow: 0 0 15px rgba(168, 85, 247, 0.3); } }

        /* MODAL & TOAST */
        #calc-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .plate { display: inline-block; width: 45px; height: 45px; line-height: 41px; text-align: center; border-radius: 50%; font-weight: bold; font-size: 12px; margin: 3px; color: #1e293b; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .plate-20 { background-color: #2563eb; color: white; width: 55px; height: 55px; line-height: 51px; } 
        .plate-15 { background-color: #eab308; } .plate-10 { background-color: #16a34a; color: white; } 
        .plate-5 { background-color: #ef4444; color: white; width: 38px; height: 38px; line-height: 34px;} 
        .plate-2-5 { background-color: #1e293b; color: white; border-color: white; width: 32px; height: 32px; line-height: 28px; } 
        .plate-1-25 { background-color: #cbd5e1; width: 28px; height: 28px; line-height: 24px; font-size: 9px; }

        #toast { visibility: hidden; min-width: 250px; background-color: #10b981; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 60; left: 50%; bottom: 100px; transform: translateX(-50%); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); opacity: 0; transition: all 0.3s; font-weight: bold; }
        #toast.show { visibility: visible; opacity: 1; bottom: 110px; }
        
        /* GRAPHIQUE */
        .chart-container { height: 150px; width: 100%; display: flex; align-items: flex-end; gap: 8px; padding-top: 20px; }
        .chart-bar { flex: 1; background: linear-gradient(to top, var(--primary), var(--primary-light)); border-radius: 4px 4px 0 0; position: relative; min-height: 4px; transition: height 0.5s ease; }
        .chart-bar span { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 9px; color: #94a3b8; width: 100%; text-align: center; }
        
        /* NUTRITION & SETTINGS */
        .meal-card { border-left: 4px solid transparent; }
        .meal-card.today { border-color: var(--primary); background-color: rgba(30, 41, 59, 0.8); box-shadow: 0 0 15px rgba(59, 130, 246, 0.15); }
        .meal-tag { font-size: 10px; text-transform: uppercase; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
        .tag-muscu { background-color: #1e3a8a; color: #93c5fd; }
        .tag-run { background-color: #451a03; color: #fbbf24; }
        .tag-rest { background-color: #064e3b; color: #6ee7b7; }
        
        .food-item { background: #334155; padding: 8px; border-radius: 8px; font-size: 11px; color: #cbd5e1; display: flex; align-items: center; gap: 6px; }
        .water-bar-bg { width: 100%; height: 8px; background: #334155; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .water-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }

        /* TOGGLE SWITCH */
        .toggle-checkbox:checked { right: 0; border-color: var(--primary); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--primary); }
        .toggle-label { width: 44px; height: 24px; position: relative; display: block; background: #334155; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .toggle-label:after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .toggle-checkbox:checked + .toggle-label:after { transform: translateX(100%); }
        .toggle-checkbox { display: none; }

        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1rem auto; padding-right: 2.5rem; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(234, 88, 12, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); } }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">

    <header class="flex justify-between items-center mb-6 px-1">
        <div>
            <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-300" id="header-title">Gym & Run</h1>
            <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase" id="header-subtitle">Coach AI V9</p>
        </div>
        <div class="bg-slate-800 p-2 rounded-full border border-slate-700 shadow-lg">
            <i data-lucide="brain-circuit" class="w-5 h-5 text-purple-400"></i>
        </div>
    </header>

    <div id="view-tracker" class="page-view active">
        <div class="mb-6">
            <div class="relative">
                <select id="day-selector" onchange="manualDayChange(this.value)" class="w-full bg-slate-800 text-white border border-slate-600 rounded-xl p-3.5 font-bold focus:outline-none focus:border-blue-500 shadow-lg appearance-none">
                </select>
            </div>
        </div>

        <div class="mb-4 px-1">
            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1 block ml-1">Date de la s√©ance</label>
            <input type="date" id="session-date" class="input-dark text-center text-slate-300 font-mono">
            <script>document.getElementById('session-date').valueAsDate = new Date();</script>
        </div>
        <div id="app-content"></div>
    </div>

    <div id="view-history" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="history" class="w-5 h-5 text-blue-400"></i> Historique</h2>
        <div id="history-list" class="space-y-3 pb-4"></div>
    </div>

    <div id="view-stats" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-400"></i> Performance</h2>
        <div class="grid grid-cols-2 gap-3 mb-6" id="weekly-stats"></div>
        <div class="card bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700">
            <h3 class="text-xs text-slate-400 uppercase font-bold mb-1">Volume Muscu (kg)</h3>
            <div id="volume-chart" class="chart-container"></div>
            <div class="flex justify-between text-[10px] text-slate-500 mt-2 px-1"><span>S-3</span><span>S-2</span><span>S-1</span><span>Actuel</span></div>
        </div>
    </div>

    <div id="view-nutrition" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="utensils" class="w-5 h-5 text-blue-400"></i> Coach Nutrition</h2>
        
        <div class="card bg-slate-800/50 border-slate-700 mb-6 relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h3 class="font-bold text-blue-100 flex items-center gap-2"><i data-lucide="glass-water" class="w-4 h-4"></i> Hydratation</h3>
                        <p class="text-xs text-blue-300" id="water-text">0 / 2500 ml</p>
                    </div>
                    <button onclick="addWater()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded-lg text-xs font-bold transition-colors">+ 250ml</button>
                </div>
                <div class="water-bar-bg"><div id="water-bar" class="water-bar-fill"></div></div>
            </div>
        </div>

        <div class="card bg-slate-800 border-slate-700 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-white text-sm">Eau : 7 Derniers jours</h3>
                <span class="text-xs text-blue-300 font-bold bg-blue-900/30 px-2 py-1 rounded" id="water-avg">Moy: 0L</span>
            </div>
            <div id="water-chart" class="h-32 w-full flex items-end justify-between gap-1 px-1"></div>
        </div>

        <div id="nutrition-list" class="space-y-3 mb-8"></div>

        <h3 class="text-md font-bold text-white mb-3 mt-8 flex items-center gap-2"><i data-lucide="book-open" class="w-4 h-4 text-emerald-400"></i> Guide des Aliments</h3>
        <div class="grid grid-cols-2 gap-3">
            <div class="card p-3 !mb-0 border-orange-500/30">
                <h4 class="text-xs font-bold text-orange-300 mb-2 uppercase">‚ö° Glucides</h4>
                <div class="space-y-1"><div class="food-item">üçö Riz Basmati</div><div class="food-item">ü•£ Avoine</div><div class="food-item">üç† Patate Douce</div></div>
            </div>
            <div class="card p-3 !mb-0 border-blue-500/30">
                <h4 class="text-xs font-bold text-blue-300 mb-2 uppercase">ü•© Prot√©ines</h4>
                <div class="space-y-1"><div class="food-item">üçó Poulet</div><div class="food-item">ü•ö ≈íufs</div><div class="food-item">üêü Poisson</div></div>
            </div>
        </div>
    </div>

    <div id="view-settings" class="page-view">
        <h2 class="text-lg font-bold text-white mb-4">Centre de Contr√¥le</h2>
        
        <div class="card border-l-4 border-l-purple-500">
            <h3 class="font-bold text-white mb-3 flex items-center gap-2"><i data-lucide="user-circle" class="w-5 h-5 text-purple-400"></i> Profil & Biom√©trie</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="text-[10px] text-slate-400 uppercase font-bold">Taille (cm)</label>
                    <input type="number" id="user-height" class="input-dark" placeholder="175" onchange="saveSettings()">
                </div>
                <div>
                    <label class="text-[10px] text-slate-400 uppercase font-bold">Age</label>
                    <input type="number" id="user-age" class="input-dark" placeholder="25" onchange="saveSettings()">
                </div>
            </div>
            
            <div class="mb-4">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-[10px] text-slate-400 uppercase font-bold">Objectif Poids (kg)</label>
                    <span id="weight-progress-txt" class="text-xs text-purple-300">--</span>
                </div>
                <input type="number" step="0.1" id="user-target-weight" class="input-dark" placeholder="75.0" onchange="saveSettings()">
                <div class="w-full bg-slate-900 rounded-full h-2 mt-2 overflow-hidden">
                    <div id="weight-progress-bar" class="bg-purple-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div id="bio-stats" class="bg-slate-800/80 p-3 rounded-lg text-center text-xs text-slate-300 border border-slate-700">
                Remplis tes infos pour voir ton IMC et Besoins.
            </div>
        </div>

        <div class="card">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="sliders" class="w-5 h-5 text-blue-400"></i> Pr√©f√©rences</h3>
            
            <div class="flex justify-between items-center mb-4">
                <span class="text-sm text-slate-300 font-medium">Sons (Timer)</span>
                <div>
                    <input type="checkbox" id="pref-sound" class="toggle-checkbox" onchange="saveSettings()" checked>
                    <label for="pref-sound" class="toggle-label"></label>
                </div>
            </div>
            <div class="flex justify-between items-center mb-4">
                <span class="text-sm text-slate-300 font-medium">Vibration Haptique</span>
                <div>
                    <input type="checkbox" id="pref-vibe" class="toggle-checkbox" onchange="saveSettings()" checked>
                    <label for="pref-vibe" class="toggle-label"></label>
                </div>
            </div>
            <div class="mb-2">
                 <div class="flex justify-between mb-1">
                    <label class="text-[10px] text-slate-400 uppercase font-bold">Objectif Eau</label>
                    <span class="text-xs text-blue-400 font-bold" id="water-val-disp">2500ml</span>
                 </div>
                 <input type="range" id="pref-water" min="1500" max="4000" step="250" class="w-full accent-blue-500" onchange="saveSettings(); document.getElementById('water-val-disp').innerText = this.value + 'ml'">
            </div>
        </div>

        <div class="card">
            <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="palette" class="w-5 h-5 text-pink-400"></i> Th√®me App</h3>
            <div class="flex gap-4 justify-center">
                <button onclick="setTheme('blue')" class="w-10 h-10 rounded-full bg-blue-500 border-2 border-slate-600 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-white"></button>
                <button onclick="setTheme('red')" class="w-10 h-10 rounded-full bg-red-500 border-2 border-slate-600 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-white"></button>
                <button onclick="setTheme('green')" class="w-10 h-10 rounded-full bg-emerald-500 border-2 border-slate-600 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-white"></button>
            </div>
        </div>

        <div class="card border-slate-700">
            <h3 class="font-bold text-white mb-3 flex items-center gap-2"><i data-lucide="hard-drive" class="w-5 h-5 text-slate-400"></i> Donn√©es</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <button onclick="exportData()" class="btn-secondary text-xs"><i data-lucide="download" class="w-3 h-3"></i> Sauvegarder</button>
                <button onclick="document.getElementById('import-file').click()" class="btn-secondary text-xs"><i data-lucide="upload" class="w-3 h-3"></i> Restaurer</button>
            </div>
            <button onclick="clearData()" class="w-full py-3 text-red-400 text-xs font-bold border border-red-900/50 rounded-lg hover:bg-red-900/20">R√©initialisation Usine</button>
            <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
        </div>

        <div class="text-center text-[10px] text-slate-600 mt-6 pb-4">
            <p>Gym & Run Coach v9.0</p>
            <a href="mailto:support@gymrun.app" class="underline hover:text-slate-400">Signaler un bug</a>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-item active" onclick="switchTab('tracker', this)"><i data-lucide="dumbbell"></i><span>S√©ance</span></div>
        <div class="nav-item" onclick="switchTab('history', this)"><i data-lucide="calendar-days"></i><span>Journal</span></div>
        <div class="nav-item" onclick="switchTab('stats', this)"><i data-lucide="bar-chart-2"></i><span>Stats</span></div>
        <div class="nav-item" onclick="switchTab('nutrition', this)"><i data-lucide="utensils"></i><span>Nutri</span></div>
        <div class="nav-item" onclick="switchTab('settings', this)"><i data-lucide="settings"></i><span>Outils</span></div>
    </nav>

    <div id="calc-modal" onclick="closeCalc()">
        <div class="bg-slate-900 p-6 rounded-2xl w-80 text-center border border-slate-700 shadow-2xl transform scale-100" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-white mb-2">Charger la Barre</h3>
            <p class="text-slate-400 text-sm mb-4">Objectif : <span id="calc-target" class="text-blue-400 font-bold text-lg">0</span> kg</p>
            <div id="calc-result" class="bg-slate-800 p-4 rounded-xl mb-4 min-h-[80px] flex flex-wrap justify-center items-center gap-1"></div>
            <div class="text-xs text-slate-500 mb-4">Barre olympique standard (20kg)</div>
            <button onclick="closeCalc()" class="btn-primary">Fermer</button>
        </div>
    </div>

    <div id="toast"><span id="toast-msg">Message</span></div>
    <audio id="timer-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
    // --- 1. SETTINGS & THEME LOGIC (NEW) ---
    let appSettings = {
        height: null, age: null, targetWeight: null, waterGoal: 2500, sound: true, vibe: true, theme: 'blue'
    };

    function loadSettings() {
        const saved = localStorage.getItem('gym_tracker_settings');
        if(saved) appSettings = JSON.parse(saved);
        
        // Apply to UI
        document.getElementById('user-height').value = appSettings.height || '';
        document.getElementById('user-age').value = appSettings.age || '';
        document.getElementById('user-target-weight').value = appSettings.targetWeight || '';
        document.getElementById('pref-sound').checked = appSettings.sound;
        document.getElementById('pref-vibe').checked = appSettings.vibe;
        document.getElementById('pref-water').value = appSettings.waterGoal;
        document.getElementById('water-val-disp').innerText = appSettings.waterGoal + 'ml';
        
        setTheme(appSettings.theme, false); // false = no save (already loaded)
        calcBio();
    }

    function saveSettings() {
        appSettings.height = document.getElementById('user-height').value;
        appSettings.age = document.getElementById('user-age').value;
        appSettings.targetWeight = document.getElementById('user-target-weight').value;
        appSettings.sound = document.getElementById('pref-sound').checked;
        appSettings.vibe = document.getElementById('pref-vibe').checked;
        appSettings.waterGoal = parseInt(document.getElementById('pref-water').value);
        
        localStorage.setItem('gym_tracker_settings', JSON.stringify(appSettings));
        calcBio();
        updateWaterDisplay(); // Refresh water goal if changed
    }

    function calcBio() {
        // Besoin du poids actuel (dernier enregistr√© dans le tracker poids, mais on l'a retir√©, 
        // donc on va chercher le dernier poids de s√©ance s'il existe ou juste faire avec taille/age)
        // Pour simplifier V9 sans l'onglet Poids, on va estimer le BMR de base.
        const h = parseInt(appSettings.height);
        const a = parseInt(appSettings.age);
        
        if(h && a) {
            // Formule simplifi√©e Mifflin-St Jeor (Poids moyen 75kg si inconnu)
            const weight = 75; 
            const bmr = (10 * weight) + (6.25 * h) - (5 * a) + 5;
            const imc = (weight / ((h/100)*(h/100))).toFixed(1);
            
            document.getElementById('bio-stats').innerHTML = `
                <div class="flex justify-around">
                    <div>
                        <div class="text-xs text-slate-400">IMC (Est.)</div>
                        <div class="text-lg font-bold text-white">${imc}</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-400">BMR (Repos)</div>
                        <div class="text-lg font-bold text-white">${Math.round(bmr)} kcal</div>
                    </div>
                </div>`;
        }
    }

    function setTheme(color, save = true) {
        const root = document.documentElement;
        let primary, primaryDark, primaryLight;

        if(color === 'red') {
            primary = '#ef4444'; primaryDark = '#b91c1c'; primaryLight = '#fca5a5';
        } else if (color === 'green') {
            primary = '#10b981'; primaryDark = '#047857'; primaryLight = '#6ee7b7';
        } else { // Blue default
            primary = '#3b82f6'; primaryDark = '#1d4ed8'; primaryLight = '#60a5fa';
        }

        root.style.setProperty('--primary', primary);
        root.style.setProperty('--primary-dark', primaryDark);
        root.style.setProperty('--primary-light', primaryLight);

        if(save) {
            appSettings.theme = color;
            saveSettings();
        }
    }

    // --- 2. DONN√âES DU PROGRAMME ---
    const program = {
        1: { type: 'muscu', title: 'Lundi : PUSH', desc: 'Pecs, √âpaules, Triceps',
            exercises: [
                { name: 'D√©velopp√© Couch√©', sets: 4, reps: '6-10', rest: '2-3 min' },
                { name: 'D√©velopp√© Inclin√© Halt√®res', sets: 3, reps: '8-12', rest: '2 min' },
                { name: 'D√©velopp√© Militaire', sets: 3, reps: '8-12', rest: '2 min' },
                { name: '√âl√©vations Lat√©rales', sets: 4, reps: '12-15', rest: '1m30' },
                { name: 'Extensions Triceps Poulie', sets: 3, reps: '10-15', rest: '1m30' }
            ]},
        2: { type: 'cardio', title: 'Mardi : RUNNING', desc: 'Endurance Fondamentale',
            exercises: [{ name: 'Course √† pied', sets: 1, reps: '45-60 min', rest: 'N/A' }]},
        3: { type: 'muscu', title: 'Mercredi : PULL', desc: 'Dos, Arri√®re √©paule, Biceps',
            exercises: [
                { name: 'Tractions (ou Tirage vertical)', sets: 4, reps: 'Max', rest: '2-3 min' },
                { name: 'Rowing Barre', sets: 3, reps: '8-12', rest: '2 min' },
                { name: 'Tirage Horizontal', sets: 3, reps: '10-12', rest: '1m30' },
                { name: 'Face Pulls', sets: 4, reps: '15-20', rest: '1m30' },
                { name: 'Curl Barre', sets: 3, reps: '8-12', rest: '1m30' }
            ]},
        4: { type: 'cardio', title: 'Jeudi : RUNNING', desc: 'Endurance - Hydratation ++',
            exercises: [{ name: 'Course √† pied', sets: 1, reps: '45-60 min', rest: 'N/A' }]},
        5: { type: 'muscu', title: 'Vendredi : UPPER BODY', desc: 'Volume & Rappel',
            exercises: [
                { name: 'Dips', sets: 3, reps: '8-12', rest: '2 min' },
                { name: 'Tirage Vertical Supination', sets: 3, reps: '8-12', rest: '2 min' },
                { name: '√âcart√© Poulie Vis-√†-vis', sets: 3, reps: '12-15', rest: '1m30' },
                { name: 'Curl Marteau', sets: 3, reps: '10-15', rest: '1m30' },
                { name: 'Extension Triceps T√™te', sets: 3, reps: '10-15', rest: '1m30' }
            ]},
        6: { type: 'cardio', title: 'Samedi : RUNNING', desc: 'Sortie Longue / Plaisir',
            exercises: [{ name: 'Course √† pied', sets: 1, reps: 'Libre', rest: 'N/A' }]},
        0: { type: 'rest', title: 'Dimanche : REPOS', desc: 'R√©cup√©ration - Low Carb', exercises: [] }
    };

    // --- 3. INITIALISATION ---
    const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
    let currentDayIndex = new Date().getDay();

    const selector = document.getElementById('day-selector');
    days.forEach((day, index) => {
        let option = document.createElement('option');
        option.value = index;
        option.text = program[index].title;
        if(index === currentDayIndex) option.selected = true;
        selector.add(option);
    });

    lucide.createIcons();
    loadSettings(); // Charger settings et th√®me
    loadDailyView(currentDayIndex);

    // --- 4. NAVIGATION ---
    function switchTab(tabId, element) {
        document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        if(tabId === 'history') renderHistory();
        if(tabId === 'stats') { renderStats(); renderVolumeChart(); }
        if(tabId === 'nutrition') { renderNutrition(); updateWaterDisplay(); renderWaterChart(); }
        
        const titles = { 'tracker': 'Gym & Run', 'history': 'Journal', 'stats': 'Statistiques', 'nutrition': 'Coach Nutri', 'settings': 'Outils' };
        document.getElementById('header-title').innerText = titles[tabId];
    }

    function manualDayChange(val) {
        currentDayIndex = parseInt(val);
        loadDailyView(currentDayIndex);
    }

    // --- 5. CORE FUNCTIONS ---
    function getCoachAdvice(lastData, targetRepString) {
        if(!lastData) return null;
        let maxTarget = 12; 
        const rangeMatch = targetRepString.match(/-(\d+)/);
        if(rangeMatch) maxTarget = parseInt(rangeMatch[1]);
        else if (targetRepString.includes('Max')) maxTarget = 20;

        const lastWeight = parseFloat(lastData.val1.replace(',','.'));
        const lastReps = parseInt(lastData.val2.split(',')[0]);

        if(isNaN(lastWeight) || isNaN(lastReps)) return null;

        if (lastReps >= maxTarget) {
            return { type: 'weight', val1: lastWeight + 2.5, val2: targetRepString, msg: `+2.5kg !` };
        } else {
            return { type: 'reps', val1: lastWeight, val2: lastReps + 1, msg: `Vise ${lastReps + 1} reps` };
        }
    }

    function loadDailyView(dayIndex) {
        const contentDiv = document.getElementById('app-content');
        const dayPlan = program[dayIndex];

        if (dayPlan.type === 'rest') {
            contentDiv.innerHTML = `
                <div class="card text-center py-12 border-t-4 border-emerald-500 bg-gradient-to-b from-emerald-900/20 to-slate-900">
                    <div class="bg-emerald-900/30 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border border-emerald-500/30">
                        <i data-lucide="coffee" class="w-10 h-10 text-emerald-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Repos</h2>
                    <p class="text-slate-400 mt-2 text-sm">${dayPlan.desc}</p>
                    <div class="mt-8 bg-slate-800/80 p-5 rounded-xl text-left text-sm border border-slate-700">
                        <p class="text-emerald-400 font-bold mb-2 flex items-center gap-2 text-xs uppercase tracking-wide"><i data-lucide="leaf" class="w-4 h-4"></i> Nutrition</p>
                        <p class="text-slate-300">Moins de glucides, plus de l√©gumes et bons lipides (avocat, noix).</p>
                    </div>
                </div>`;
            lucide.createIcons();
            return;
        }

        const isCardio = dayPlan.type === 'cardio';
        let html = `<form id="workout-form" onsubmit="event.preventDefault();">`;

        dayPlan.exercises.forEach((exo, index) => {
            const historyData = getHistoryData(exo.name);
            const lastData = historyData.last;
            
            let historyHTML = '';
            if (!lastData) {
                historyHTML = `<div class="text-xs text-slate-500 mb-3 italic flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> Pas d'historique</div>`;
            } else {
                const lastText = isCardio ? `${lastData.val1}km / ${lastData.val2}` : `${lastData.val1}kg x ${lastData.val2}`;
                let coachHTML = '';
                if(!isCardio) {
                    const advice = getCoachAdvice(lastData, exo.reps);
                    if(advice) {
                        coachHTML = `<div onclick="fillInputs(${index}, '${advice.val1}', '${advice.val2}')" class="clickable-history coach" title="Appliquer le conseil"><i data-lucide="sparkles" class="w-3 h-3"></i> Coach: <strong>${advice.msg}</strong></div>`;
                    }
                }
                historyHTML = `<div class="flex gap-2 mb-3 overflow-x-auto no-scrollbar"><div onclick="fillInputs(${index}, '${lastData.val1}', '${lastData.val2}')" class="clickable-history last" title="Copier dernier"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> Last: <strong>${lastText}</strong></div>${coachHTML}</div>`;
            }

            let actionBtn = '';
            if (!isCardio && exo.rest !== 'N/A') {
                const seconds = parseRestToSeconds(exo.rest);
                actionBtn = `<button type="button" class="timer-btn" onclick="startTimer(this, ${seconds})"><i data-lucide="timer" class="w-3 h-3"></i> ${exo.rest}</button>`;
            }

            let calcBtn = '';
            if (!isCardio && !exo.name.includes('Halt√®res') && !exo.name.includes('Poulie')) {
                calcBtn = `<i data-lucide="scale" class="w-4 h-4 calc-btn" onclick="openCalc(document.getElementById('val1_${index}').value)"></i>`;
            }

            const label1 = isCardio ? "Distance (km)" : "Charge (kg)";
            const place1 = isCardio ? "Ex: 8.5" : "Ex: 60";
            const label2 = isCardio ? "Temps (min)" : "Reps";
            const place2 = isCardio ? "Ex: 45:30" : "Ex: 10,10,9";

            html += `
                <div class="card relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg text-blue-100 flex items-center gap-2 leading-tight">${exo.name}</h3>
                            <div class="text-xs text-slate-400 mt-1 mb-2 font-medium flex items-center gap-2">
                                <span class="bg-slate-700/50 px-1.5 py-0.5 rounded text-slate-300 border border-slate-600">${exo.sets} s√©ries</span>
                                <span class="text-slate-600">‚Ä¢</span>
                                <span>${exo.reps} reps</span>
                            </div>
                        </div>
                        ${actionBtn}
                    </div>
                    ${historyHTML}
                    <div class="grid grid-cols-2 gap-3 relative">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1.5 block ml-1">${label1}</label>
                            <div class="relative"><input type="number" id="val1_${index}" name="val1_${index}" class="input-dark font-mono text-center text-blue-100 pl-2 pr-6" placeholder="${place1}" inputmode="decimal">${calcBtn}</div>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1.5 block ml-1">${label2}</label>
                            <input type="text" id="val2_${index}" name="val2_${index}" class="input-dark font-mono text-center text-blue-100" placeholder="${place2}" inputmode="${isCardio ? 'text' : 'text'}">
                        </div>
                    </div>
                </div>`;
        });

        html += `
            <div class="card"><label class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-2 block flex items-center gap-2"><i data-lucide="sticky-note" class="w-3 h-3"></i> Notes</label><textarea name="notes" class="input-dark text-sm min-h-[60px] font-normal text-slate-300" placeholder="Sensations..."></textarea></div>
            <button type="button" onclick="saveWorkout(${dayIndex})" class="btn-primary mb-8 text-lg shadow-blue-900/20 shadow-xl">Valider la s√©ance</button>
            </form>`;

        contentDiv.innerHTML = html;
        lucide.createIcons();
    }

    // --- WATER ---
    function getWater() {
        const todayStr = new Date().toLocaleDateString('fr-FR');
        const data = JSON.parse(localStorage.getItem('gym_tracker_water') || '[]');
        const entry = data.find(d => d.date === todayStr);
        return entry ? entry.amount : 0;
    }

    function addWater() {
        const todayStr = new Date().toLocaleDateString('fr-FR');
        let data = JSON.parse(localStorage.getItem('gym_tracker_water') || '[]');
        let index = data.findIndex(d => d.date === todayStr);
        if(index !== -1) { data[index].amount += 250; } else { data.push({ date: todayStr, amount: 250 }); }
        localStorage.setItem('gym_tracker_water', JSON.stringify(data));
        updateWaterDisplay(); renderWaterChart();
        if(appSettings.vibe && navigator.vibrate) navigator.vibrate(50);
    }

    function updateWaterDisplay() {
        const current = getWater();
        const max = appSettings.waterGoal;
        const pct = Math.min((current / max) * 100, 100);
        document.getElementById('water-text').innerText = `${current} / ${max} ml`;
        document.getElementById('water-bar').style.width = `${pct}%`;
    }

    function renderWaterChart() {
        const container = document.getElementById('water-chart');
        const data = JSON.parse(localStorage.getItem('gym_tracker_water') || '[]');
        const last7Days = [];
        let totalWeek = 0;
        
        for (let i = 6; i >= 0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const dateStr = d.toLocaleDateString('fr-FR');
            const entry = data.find(item => item.date === dateStr);
            const amount = entry ? entry.amount : 0;
            totalWeek += amount;
            last7Days.push({ day: d.toLocaleDateString('fr-FR', { weekday: 'short' }), amount: amount });
        }
        const avg = Math.round(totalWeek / 7);
        document.getElementById('water-avg').innerText = `Moy: ${(avg/1000).toFixed(1)}L`;

        let html = '';
        last7Days.forEach(day => {
            const heightPct = Math.min((day.amount / 3000) * 100, 100);
            const colorClass = day.amount >= appSettings.waterGoal ? 'bg-blue-400' : 'bg-blue-800';
            html += `<div class="flex flex-col items-center w-full group relative"><div class="w-full ${colorClass} rounded-t-sm transition-all duration-500 relative" style="height: ${heightPct}%"><span class="absolute -top-6 left-1/2 -translate-x-1/2 text-[9px] bg-slate-900 px-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap border border-slate-700">${day.amount}ml</span></div><span class="text-[9px] text-slate-500 mt-1 uppercase">${day.day.replace('.','')}</span><div class="absolute bottom-[${(appSettings.waterGoal/3000)*100}%] w-full h-[1px] bg-red-500/30 z-0 pointer-events-none"></div></div>`;
        });
        container.innerHTML = html;
    }

    // --- RENDER NUTRITION ---
    async function renderNutrition() {
        const list = document.getElementById('nutrition-list');
        const today = new Date().getDay();
        
        try {
            // Appel du fichier externe
            const response = await fetch('nutrition.json');
            
            if (!response.ok) {
                throw new Error("Impossible de charger le fichier nutrition.json");
            }
            
            const nutriPlan = await response.json();
            let html = '';
            
            // On r√©organise pour l'affichage (Lundi en premier)
            // On cherche les jours dans l'ordre 1,2,3,4,5,6,0
            const orderedDays = [1, 2, 3, 4, 5, 6, 0];
            
            orderedDays.forEach(dayIndex => {
                // Trouver le plan correspondant au jour
                const item = nutriPlan.find(p => p.day === dayIndex);
                if(!item) return;

                const isToday = item.day === today;
                const activeClass = isToday ? 'today' : 'opacity-70 grayscale hover:grayscale-0 transition-all';
                const icon = item.type === 'muscu' ? 'dumbbell' : (item.type === 'run' ? 'footprints' : 'coffee');
                
                // Gestion des tags de couleur
                let tag = '';
                if (item.type === 'muscu') tag = '<span class="meal-tag tag-muscu">Force</span>';
                else if (item.type === 'run') tag = '<span class="meal-tag tag-run">Cardio</span>';
                else tag = '<span class="meal-tag tag-rest">Repos</span>';

                // Construction de la liste des repas depuis le JSON
                let detailsHtml = '<ul class="text-xs text-slate-300 space-y-1 list-disc pl-4 mt-2">';
                item.details.forEach(detail => {
                    detailsHtml += `<li><strong>${detail.label}:</strong> ${detail.text}</li>`;
                });
                detailsHtml += '</ul>';

                html += `
                    <div class="card meal-card ${activeClass} mb-3" id="day-${item.day}">
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${icon}" class="w-4 h-4 text-slate-400"></i>
                                <h3 class="font-bold text-white text-sm">${item.title}</h3>
                            </div>
                            ${tag}
                        </div>
                        ${detailsHtml}
                    </div>
                `;
            });

            list.innerHTML = html;
            lucide.createIcons();
            
            // Auto-scroll
            if(document.querySelector('.today')) {
                setTimeout(() => document.querySelector('.today').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            }

        } catch (error) {
            console.error(error);
            list.innerHTML = `<div class="text-red-400 text-center p-4 border border-red-900 rounded-lg bg-red-900/10">
                <p class="font-bold">Erreur de chargement</p>
                <p class="text-xs mt-1">Assurez-vous que le fichier <b>nutrition.json</b> est bien pr√©sent.</p>
                <p class="text-[10px] mt-2 opacity-70">Note : Cela n√©cessite un serveur local (Live Server).</p>
            </div>`;
        }
    }

    // --- HELPERS ---
    function saveWorkout(dayIndex) {
        const form = document.getElementById('workout-form');
        const dayPlan = program[dayIndex];
        const dateInput = document.getElementById('session-date').value;
        let dateStr, timestamp;
        if (dateInput) { const [y, m, d] = dateInput.split('-'); dateStr = `${d}/${m}/${y}`; timestamp = new Date(y, m - 1, d).getTime(); }
        else { const now = new Date(); dateStr = now.toLocaleDateString('fr-FR'); timestamp = now.getTime(); }
        
        let sessionData = { date: dateStr, timestamp: timestamp, title: dayPlan.title, type: dayPlan.type, notes: form.notes ? form.notes.value : "", exercises: [] };
        dayPlan.exercises.forEach((exo, index) => {
            const val1 = form[`val1_${index}`].value;
            const val2 = form[`val2_${index}`].value;
            if(val1 || val2) sessionData.exercises.push({ name: exo.name, val1: val1 || '-', val2: val2 || '-' });
        });
        if (sessionData.exercises.length === 0) { showToast("Vide !", true); return; }
        let history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        history.unshift(sessionData); history.sort((a, b) => b.timestamp - a.timestamp);
        localStorage.setItem('gym_tracker_data_v2', JSON.stringify(history));
        showToast("Valid√© ! üî•"); form.reset(); document.getElementById('session-date').valueAsDate = new Date(); loadDailyView(dayIndex);
    }

    function editSessionDate(index) {
        let history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        const newDateStr = prompt("Date (JJ/MM/AAAA) :", history[index].date);
        if (newDateStr && newDateStr !== history[index].date) {
            const parts = newDateStr.split('/');
            if(parts.length === 3) {
                history[index].date = newDateStr; history[index].timestamp = new Date(parts[2], parts[1]-1, parts[0]).getTime();
                history.sort((a, b) => b.timestamp - a.timestamp);
                localStorage.setItem('gym_tracker_data_v2', JSON.stringify(history));
                renderHistory(); renderStats(); showToast("Modifi√© !");
            }
        }
    }

    function renderStats() {
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        const statsDiv = document.getElementById('weekly-stats');
        const now = new Date(); const todayStr = now.toLocaleDateString('fr-FR'); 
        const curMonth = now.getMonth(); const curYear = now.getFullYear();
        const data = { day: { gym: 0, run: 0 }, month: { gym: 0, run: 0 }, year: { gym: 0, run: 0 }, all: { gym: 0, run: 0 } };

        history.forEach(session => {
            const [d, m, y] = session.date.split('/').map(Number);
            const isToday = session.date === todayStr; const isMonth = (m - 1) === curMonth && y === curYear; const isYear = y === curYear;
            if (session.type === 'muscu') { data.all.gym++; if(isYear) data.year.gym++; if(isMonth) data.month.gym++; if(isToday) data.day.gym++; } 
            else if (session.type === 'cardio') {
                let km = 0; session.exercises.forEach(ex => { const val = parseFloat(ex.val1.replace(',', '.')); if (!isNaN(val)) km += val; });
                data.all.run += km; if(isYear) data.year.run += km; if(isMonth) data.month.run += km; if(isToday) data.day.run += km;
            }
        });
        const mkCard = (label, icon, gym, run) => `<div class="bg-slate-700/50 p-3 rounded-xl border border-slate-600 flex flex-col justify-between h-24"><div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider flex items-center gap-1"><i data-lucide="${icon}" class="w-3 h-3"></i> ${label}</div><div><div class="flex justify-between items-center mb-1"><span class="text-xs text-blue-300 font-bold">Muscu</span><span class="text-lg font-black text-white leading-none">${gym}</span></div><div class="flex justify-between items-center"><span class="text-xs text-amber-300 font-bold">Run</span><span class="text-lg font-black text-white leading-none">${run.toFixed(1)}<span class="text-[10px] text-slate-500 font-normal ml-0.5">km</span></span></div></div></div>`;
        statsDiv.innerHTML = `${mkCard('Aujourd\'hui', 'calendar', data.day.gym, data.day.run)}${mkCard('Ce Mois', 'calendar-days', data.month.gym, data.month.run)}${mkCard('Cette Ann√©e', 'calendar-range', data.year.gym, data.year.run)}${mkCard('Total', 'trophy', data.all.gym, data.all.run)}`;
        lucide.createIcons();
    }

    function renderVolumeChart() {
        const container = document.getElementById('volume-chart');
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        const weeks = [0,0,0,0]; const now = new Date(); const oneWeek = 7 * 24 * 60 * 60 * 1000;
        history.forEach(session => {
            if(session.type !== 'muscu') return;
            const diff = now.getTime() - session.timestamp; const weekIndex = 3 - Math.floor(diff / oneWeek);
            if(weekIndex >= 0 && weekIndex <= 3) {
                let sessionVol = 0; session.exercises.forEach(ex => { const w = parseFloat(ex.val1); const rStr = ex.val2.split(',').map(s => parseInt(s)); const totalReps = rStr.reduce((a,b) => a + (isNaN(b)?0:b), 0); if(!isNaN(w)) sessionVol += w * totalReps; });
                weeks[weekIndex] += sessionVol;
            }
        });
        const maxVol = Math.max(...weeks, 1);
        let html = '';
        weeks.forEach((vol, i) => {
            const heightPct = Math.round((vol / maxVol) * 100); const color = i === 3 ? 'bg-blue-500' : 'bg-slate-700';
            html += `<div class="chart-bar ${color}" style="height: ${heightPct}%"><span class="text-[9px]">${(vol/1000).toFixed(1)}k</span></div>`;
        });
        container.innerHTML = html;
    }

    function getHistoryData(exoName) {
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        let last = null, best = null;
        for (let session of history) {
            const found = session.exercises.find(e => e.name === exoName || e.name.includes(exoName));
            if (found) { if(!last) last = found; const val = parseFloat(found.val1.replace(',','.')); if (!isNaN(val) && (!best || val > parseFloat(best.val1.replace(',','.')))) best = found; }
        }
        return { last, best };
    }

    function openCalc(weightVal) {
        if(!weightVal) { showToast("Poids manquant", true); return; }
        document.getElementById('calc-target').innerText = parseFloat(weightVal.replace(',','.'));
        document.getElementById('calc-modal').style.display = 'flex';
        let remainder = (parseFloat(weightVal.replace(',','.')) - 20) / 2;
        const div = document.getElementById('calc-result'); div.innerHTML = '';
        if (remainder <= 0) { div.innerHTML = '<span class="text-slate-400 text-sm">Juste la barre (20kg)</span>'; return; }
        [20, 15, 10, 5, 2.5, 1.25].forEach(p => {
            while (remainder >= p) { div.innerHTML += `<div class="plate plate-${p.toString().replace('.','-')}">${p}</div>`; remainder -= p; remainder = Math.round(remainder * 100) / 100; }
        });
    }
    function closeCalc() { document.getElementById('calc-modal').style.display = 'none'; }

    function showToast(message, isError = false) {
        const toast = document.getElementById("toast"); document.getElementById("toast-msg").innerText = message;
        toast.className = isError ? "error show" : "show"; if(appSettings.vibe && navigator.vibrate) navigator.vibrate(50);
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }

    function fillInputs(index, val1, val2) { document.getElementById(`val1_${index}`).value = val1; document.getElementById(`val2_${index}`).value = val2; showToast("Recopi√© !"); }
    function parseRestToSeconds(restStr) { if(!restStr) return 60; const match = restStr.match(/\d+/); return match ? parseInt(match[0]) * 60 : 90; }
    
    let activeTimerInterval = null;
    function startTimer(btn, duration) {
        if(activeTimerInterval) clearInterval(activeTimerInterval);
        document.querySelectorAll('.timer-btn').forEach(b => { b.classList.remove('active'); b.innerHTML = '<i data-lucide="timer" class="w-3 h-3"></i> ' + b.innerText.split(' ').pop(); lucide.createIcons(); });
        let timeLeft = duration; btn.classList.add('active');
        const updateTimer = () => {
            const min = Math.floor(timeLeft / 60); const sec = timeLeft % 60;
            btn.innerHTML = `<i data-lucide="hourglass" class="w-3 h-3"></i> ${min}:${sec < 10 ? '0'+sec : sec}`; lucide.createIcons();
            if (timeLeft <= 0) { clearInterval(activeTimerInterval); btn.classList.remove('active'); btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> Termin√©!`; lucide.createIcons(); if(appSettings.sound) document.getElementById('timer-sound').play().catch(() => {}); if(appSettings.vibe && navigator.vibrate) navigator.vibrate([200, 100, 200]); }
            timeLeft--;
        };
        updateTimer(); activeTimerInterval = setInterval(updateTimer, 1000);
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        if (history.length === 0) { list.innerHTML = '<div class="text-slate-500 text-center py-8">Aucune s√©ance.</div>'; return; }
        let html = '';
        history.forEach((session, index) => {
            const isCardio = session.type === 'cardio'; const color = isCardio ? 'text-amber-400' : 'text-blue-400';
            html += `<div class="bg-slate-800 p-4 rounded-xl border border-slate-700 relative group"><button onclick="deleteSession(${index})" class="absolute top-4 right-4 text-slate-600 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button><div class="flex items-center gap-3 mb-3 pb-3 border-b border-slate-700/50"><div class="bg-slate-700/50 p-2 rounded-lg"><i data-lucide="${isCardio ? 'footprints' : 'dumbbell'}" class="w-5 h-5 ${color}"></i></div><div><div class="flex items-center gap-2"><div class="text-white font-bold text-sm">${session.date}</div><button onclick="editSessionDate(${index})" class="text-slate-500 hover:text-blue-400"><i data-lucide="pencil" class="w-3 h-3"></i></button></div><div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">${session.title.split(':')[1] || session.title}</div></div></div><ul class="text-sm space-y-2">`;
            session.exercises.forEach(ex => { let disp = isCardio ? `<span class="text-amber-300 font-bold">${ex.val1}km</span>` : `<span class="bg-slate-700 px-2 rounded text-xs border border-slate-600">${ex.val1}kg x ${ex.val2}</span>`; html += `<li class="flex justify-between items-center text-slate-300"><span class="truncate pr-4">${ex.name}</span>${disp}</li>`; });
            html += `</ul></div>`;
        });
        list.innerHTML = html; lucide.createIcons();
    }

    function deleteSession(index) { if(confirm("Supprimer ?")) { let h = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]'); h.splice(index, 1); localStorage.setItem('gym_tracker_data_v2', JSON.stringify(h)); renderHistory(); renderStats(); renderVolumeChart(); } }
    function exportData() { const data = { history: JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]'), water: JSON.parse(localStorage.getItem('gym_tracker_water') || '[]'), settings: appSettings }; const blob = new Blob([JSON.stringify(data)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `gym_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = e => { try { const data = JSON.parse(e.target.result); if(data.history) localStorage.setItem('gym_tracker_data_v2', JSON.stringify(data.history)); if(data.water) localStorage.setItem('gym_tracker_water', JSON.stringify(data.water)); if(data.settings) { localStorage.setItem('gym_tracker_settings', JSON.stringify(data.settings)); loadSettings(); } showToast("Succ√®s !"); setTimeout(() => location.reload(), 1000); } catch(err) { showToast("Erreur", true); } }; reader.readAsText(file); }
    function clearData() { if(confirm("Tout effacer ?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
