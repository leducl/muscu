<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym & Run Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); position: relative; border: 1px solid #334155; }
        .input-dark { background-color: #0f172a; border: 1px solid #334155; color: white; padding: 0.6rem; border-radius: 8px; width: 100%; transition: 0.2s; font-size: 16px; font-weight: bold; }
        .input-dark:focus { border-color: #3b82f6; outline: none; background-color: #172033; }
        
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 0.8rem; border-radius: 10px; font-weight: bold; width: 100%; text-align: center; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-secondary { background-color: #334155; color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; transition: 0.2s; }
        
        .timer-btn { background-color: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #60a5fa; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: 600; }
        .timer-btn.active { background-color: #ea580c; border-color: #ea580c; color: white; animation: pulse 1.5s infinite; }
        
        .calc-btn { position: absolute; right: 10px; top: 32px; color: #94a3b8; padding: 4px; cursor: pointer; z-index: 10; }
        .calc-btn:hover { color: #3b82f6; }

        .clickable-history { cursor: pointer; border-radius: 4px; padding: 2px 6px; margin-right: 4px; display: inline-flex; align-items: center; gap: 4px; font-size: 0.7rem; border: 1px solid transparent; }
        .clickable-history.last { background-color: rgba(59, 130, 246, 0.1); color: #93c5fd; border-color: rgba(59, 130, 246, 0.2); }
        .clickable-history.best { background-color: rgba(234, 179, 8, 0.1); color: #fde047; border-color: rgba(234, 179, 8, 0.2); }

        /* MODAL CALCULATOR */
        #calc-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .plate { display: inline-block; width: 40px; height: 40px; line-height: 40px; text-align: center; border-radius: 50%; font-weight: bold; font-size: 12px; margin: 2px; color: #1e293b; border: 2px solid rgba(255,255,255,0.2); }
        .plate-20 { background-color: #2563eb; color: white; height: 50px; width: 50px; line-height: 46px; } /* Bleu */
        .plate-15 { background-color: #eab308; } /* Jaune */
        .plate-10 { background-color: #16a34a; color: white; } /* Vert */
        .plate-5 { background-color: #ef4444; color: white; height: 35px; width: 35px; line-height: 32px;} /* Rouge */
        .plate-2-5 { background-color: #1e293b; color: white; border-color: white; height: 30px; width: 30px; line-height: 26px; } /* Noir */
        .plate-1-25 { background-color: #cbd5e1; height: 25px; width: 25px; line-height: 22px; font-size: 9px; } /* Gris */

        /* TOAST */
        #toast { visibility: hidden; min-width: 250px; background-color: #10b981; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 50; left: 50%; bottom: 30px; transform: translateX(-50%); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); opacity: 0; transition: all 0.3s; font-weight: bold; font-size: 0.9rem; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.error { background-color: #ef4444; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(234, 88, 12, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); } }
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1rem auto; padding-right: 2.5rem; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">

    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-300">Gym & Run</h1>
            <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase">Ultimate Edition</p>
        </div>
        <button onclick="toggleHistory()" class="text-slate-300 hover:text-white p-3 rounded-full bg-slate-800 border border-slate-700">
            <i data-lucide="history" class="w-5 h-5"></i>
        </button>
    </header>

    <div class="mb-6">
        <div class="relative">
            <select id="day-selector" onchange="manualDayChange(this.value)" class="w-full bg-slate-800 text-white border border-slate-600 rounded-xl p-3.5 font-bold focus:outline-none focus:border-blue-500 shadow-lg">
                </select>
        </div>
    </div>

    <div id="app-content"></div>

    <div id="history-view" class="hidden">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-white"><i data-lucide="bar-chart-2" class="text-blue-400"></i> Dashboard</h2>
        
        <div id="weekly-stats" class="grid grid-cols-2 gap-3 mb-6"></div> <div id="history-list" class="space-y-3 mb-8"></div>
        
        <div class="border-t border-slate-700 pt-6">
            <h3 class="text-xs font-bold text-slate-500 mb-3 uppercase tracking-wider">Sauvegarde</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <button onclick="exportData()" class="btn-secondary text-xs bg-blue-900/30 border border-blue-800/50 text-blue-200">
                    <i data-lucide="download" class="w-3 h-3"></i> Exporter
                </button>
                <button onclick="document.getElementById('import-file').click()" class="btn-secondary text-xs bg-slate-700 border border-slate-600">
                    <i data-lucide="upload" class="w-3 h-3"></i> Importer
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
            </div>
            
            <button onclick="toggleHistory()" class="mt-4 btn-secondary w-full py-3">Retour au programme</button>
            <button onclick="clearData()" class="mt-6 text-red-400 text-xs w-full text-center hover:text-red-300">R√©initialiser l'application</button>
        </div>
    </div>

    <div id="calc-modal" onclick="closeCalc()">
        <div class="bg-slate-900 p-6 rounded-2xl w-80 text-center border border-slate-700 shadow-2xl transform scale-100" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-white mb-2">Chargement Barre</h3>
            <p class="text-slate-400 text-sm mb-4">Objectif : <span id="calc-target" class="text-blue-400 font-bold text-lg">0</span> kg</p>
            
            <div id="calc-result" class="bg-slate-800 p-4 rounded-xl mb-4 min-h-[80px] flex flex-wrap justify-center items-center gap-1">
                </div>
            
            <div class="text-xs text-slate-500 mb-4">Barre olympique standard (20kg)</div>
            <button onclick="closeCalc()" class="btn-primary">Fermer</button>
        </div>
    </div>

    <div id="toast"><span id="toast-msg">Message</span></div>
    <audio id="timer-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
    // --- 1. DONN√âES DU PROGRAMME ---
    const program = {
        1: { type: 'muscu', title: 'Lundi : PUSH', desc: 'Pecs, √âpaules, Triceps',
            exercises: [
                { name: 'D√©velopp√© Couch√©', sets: 4, reps: '6-10', rest: '2-3 min' },
                { name: 'D√©velopp√© Inclin√© Halt√®res', sets: 3, reps: '8-12', rest: '2 min' },
                { name: 'D√©velopp√© Militaire', sets: 3, reps: '8-12', rest: '2 min' },
                { name: '√âl√©vations Lat√©rales', sets: 4, reps: '12-15', rest: '1m30' },
                { name: 'Extensions Triceps Poulie', sets: 3, reps: '10-15', rest: '1m30' }
            ]},
        2: { type: 'cardio', title: 'Mardi : RUNNING', desc: 'Endurance Fondamentale',
            exercises: [{ name: 'Course √† pied', sets: 1, reps: '45-60 min', rest: 'N/A' }]},
        3: { type: 'muscu', title: 'Mercredi : PULL', desc: 'Dos, Arri√®re √©paule, Biceps',
            exercises: [
                { name: 'Tractions (ou Tirage vertical)', sets: 4, reps: 'Max', rest: '2-3 min' },
                { name: 'Rowing Barre', sets: 3, reps: '8-12', rest: '2 min' },
                { name: 'Tirage Horizontal', sets: 3, reps: '10-12', rest: '1m30' },
                { name: 'Face Pulls', sets: 4, reps: '15-20', rest: '1m30' },
                { name: 'Curl Barre', sets: 3, reps: '8-12', rest: '1m30' }
            ]},
        4: { type: 'cardio', title: 'Jeudi : RUNNING', desc: 'Endurance - Hydratation ++',
            exercises: [{ name: 'Course √† pied', sets: 1, reps: '45-60 min', rest: 'N/A' }]},
        5: { type: 'muscu', title: 'Vendredi : UPPER BODY', desc: 'Volume & Rappel',
            exercises: [
                { name: 'Dips', sets: 3, reps: '8-12', rest: '2 min' },
                { name: 'Tirage Vertical Supination', sets: 3, reps: '8-12', rest: '2 min' },
                { name: '√âcart√© Poulie Vis-√†-vis', sets: 3, reps: '12-15', rest: '1m30' },
                { name: 'Curl Marteau', sets: 3, reps: '10-15', rest: '1m30' },
                { name: 'Extension Triceps T√™te', sets: 3, reps: '10-15', rest: '1m30' }
            ]},
        6: { type: 'cardio', title: 'Samedi : RUNNING', desc: 'Sortie Longue / Plaisir',
            exercises: [{ name: 'Course √† pied', sets: 1, reps: 'Libre', rest: 'N/A' }]},
        0: { type: 'rest', title: 'Dimanche : REPOS', desc: 'R√©cup√©ration - Low Carb', exercises: [] }
    };

    // --- 2. INITIALISATION ---
    const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
    let currentDayIndex = new Date().getDay();

    const selector = document.getElementById('day-selector');
    days.forEach((day, index) => {
        let option = document.createElement('option');
        option.value = index;
        option.text = program[index].title;
        if(index === currentDayIndex) option.selected = true;
        selector.add(option);
    });

    lucide.createIcons();
    loadDailyView(currentDayIndex);

    function manualDayChange(val) {
        currentDayIndex = parseInt(val);
        loadDailyView(currentDayIndex);
    }

    // --- 3. RENDU DES VUES ---
    function loadDailyView(dayIndex) {
        const contentDiv = document.getElementById('app-content');
        const dayPlan = program[dayIndex];

        // VUE REPOS
        if (dayPlan.type === 'rest') {
            contentDiv.innerHTML = `
                <div class="card text-center py-12 border-t-4 border-emerald-500 bg-gradient-to-b from-emerald-900/20 to-slate-900">
                    <div class="bg-emerald-900/30 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border border-emerald-500/30">
                        <i data-lucide="coffee" class="w-10 h-10 text-emerald-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Jour de Repos</h2>
                    <p class="text-slate-400 mt-2 text-sm">${dayPlan.desc}</p>
                    <div class="mt-8 bg-slate-800/80 p-5 rounded-xl text-left text-sm border border-slate-700">
                        <p class="text-emerald-400 font-bold mb-2 flex items-center gap-2 text-xs uppercase tracking-wide"><i data-lucide="leaf" class="w-4 h-4"></i> Nutrition Focus</p>
                        <p class="text-slate-300 leading-relaxed">R√©duis les glucides aujourd'hui. Augmente les l√©gumes et les bons lipides pour optimiser la r√©cup√©ration hormonale.</p>
                    </div>
                </div>`;
            lucide.createIcons();
            return;
        }

        const isCardio = dayPlan.type === 'cardio';
        const label1 = isCardio ? "Distance (km)" : "Charge (kg)";
        const place1 = isCardio ? "Ex: 8.5" : "Ex: 60";
        const label2 = isCardio ? "Temps (min)" : "Reps";
        const place2 = isCardio ? "Ex: 45:30" : "Ex: 10,10,9,8";
        
        let html = `<form id="workout-form" onsubmit="event.preventDefault();">`;

        dayPlan.exercises.forEach((exo, index) => {
            const historyData = getHistoryData(exo.name);
            const lastData = historyData.last;
            const bestData = historyData.best;
            
            // Ligne Historique (Dernier + Record)
            let historyHTML = '';
            if (!lastData) {
                historyHTML = `<div class="text-xs text-slate-500 mb-3 italic flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> Pas d'historique</div>`;
            } else {
                const lastText = isCardio ? `${lastData.val1}km en ${lastData.val2}` : `${lastData.val1}kg x ${lastData.val2}`;
                const bestText = bestData ? (isCardio ? `${bestData.val1}km` : `${bestData.val1}kg`) : '-';

                historyHTML = `
                    <div class="flex gap-2 mb-3 overflow-x-auto">
                        <div onclick="fillInputs(${index}, '${lastData.val1}', '${lastData.val2}')" 
                             class="clickable-history last" title="Copier dernier">
                            <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Dernier: <strong>${lastText}</strong>
                        </div>
                        <div class="clickable-history best" title="Votre Record !">
                            <i data-lucide="trophy" class="w-3 h-3"></i> Record: <strong>${bestText}</strong>
                        </div>
                    </div>`;
            }

            // Bouton Timer ou Info
            let actionBtn = '';
            if (!isCardio && exo.rest !== 'N/A') {
                const seconds = parseRestToSeconds(exo.rest);
                actionBtn = `
                    <button type="button" class="timer-btn" onclick="startTimer(this, ${seconds})">
                        <i data-lucide="timer" class="w-3 h-3"></i> ${exo.rest}
                    </button>`;
            }

            // Calculateur de disques (Seulement pour muscu)
            let calcBtn = '';
            if (!isCardio && !exo.name.includes('Halt√®res') && !exo.name.includes('Poulie')) {
                calcBtn = `<i data-lucide="scale" class="w-4 h-4 calc-btn" onclick="openCalc(document.getElementById('val1_${index}').value)" title="Calculer les disques"></i>`;
            }

            html += `
                <div class="card relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg text-blue-100 flex items-center gap-2 leading-tight">${exo.name}</h3>
                            <div class="text-xs text-slate-400 mt-1 mb-2 font-medium flex items-center gap-2">
                                <span class="bg-slate-700/50 px-1.5 py-0.5 rounded text-slate-300 border border-slate-600">${exo.sets} s√©ries</span>
                                <span class="text-slate-600">‚Ä¢</span>
                                <span>${exo.reps} reps</span>
                            </div>
                        </div>
                        ${actionBtn}
                    </div>
                    ${historyHTML}
                    <div class="grid grid-cols-2 gap-3 relative">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1.5 block ml-1">${label1}</label>
                            <div class="relative">
                                <input type="number" id="val1_${index}" name="val1_${index}" class="input-dark font-mono text-center text-blue-100 pl-2 pr-6" placeholder="${place1}" inputmode="decimal">
                                ${calcBtn}
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1.5 block ml-1">${label2}</label>
                            <input type="text" id="val2_${index}" name="val2_${index}" class="input-dark font-mono text-center text-blue-100" placeholder="${place2}" inputmode="${isCardio ? 'text' : 'text'}">
                        </div>
                    </div>
                </div>
            `;
        });

        html += `
            <div class="card">
                <label class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-2 block flex items-center gap-2">
                    <i data-lucide="sticky-note" class="w-3 h-3"></i> Notes de s√©ance
                </label>
                <textarea name="notes" class="input-dark text-sm min-h-[60px] font-normal text-slate-300" placeholder="Sensations, douleurs, √©nergie..."></textarea>
            </div>

            <button type="button" onclick="saveWorkout(${dayIndex})" class="btn-primary mb-8 text-lg shadow-blue-900/20 shadow-xl">
                <i data-lucide="check-circle-2" class="inline w-5 h-5 mr-2"></i> Valider la s√©ance
            </button>
            </form>
        `;

        contentDiv.innerHTML = html;
        lucide.createIcons();
    }

    // --- 4. FEATURES "PRO" (Calculateur, PR, Timer) ---

    // A. CALCULATEUR DE DISQUES
    function openCalc(weightVal) {
        if(!weightVal) { showToast("Entre un poids d'abord !", true); return; }
        const weight = parseFloat(weightVal.replace(',','.'));
        const modal = document.getElementById('calc-modal');
        const targetDisplay = document.getElementById('calc-target');
        const resultDisplay = document.getElementById('calc-result');

        targetDisplay.innerText = weight;
        modal.style.display = 'flex';

        // Logique de calcul (Barre 20kg)
        let remainder = (weight - 20) / 2;
        resultDisplay.innerHTML = '';

        if (remainder <= 0) {
            resultDisplay.innerHTML = '<span class="text-slate-400 text-sm">Juste la barre (20kg)</span>';
            return;
        }

        const plates = [20, 15, 10, 5, 2.5, 1.25];
        let html = '<div class="text-slate-300 text-xs w-full text-center mb-2">Par c√¥t√© :</div>';

        plates.forEach(p => {
            while (remainder >= p) {
                // Remplacement des points par des tirets pour les classes CSS (ex: plate-2-5)
                const className = `plate-${p.toString().replace('.','-')}`;
                html += `<div class="plate ${className}">${p}</div>`;
                remainder -= p;
                // Correction d'arrondi JS
                remainder = Math.round(remainder * 100) / 100;
            }
        });

        if (remainder > 0) {
            html += `<div class="text-red-400 text-xs w-full mt-2">Reste: ${remainder}kg (Impossible)</div>`;
        }
        resultDisplay.innerHTML = html;
    }

    function closeCalc() {
        document.getElementById('calc-modal').style.display = 'none';
    }

    // B. LOGIQUE HISTORIQUE AVANCEE (PR)
    function getHistoryData(exoName) {
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        let last = null;
        let best = null;

        // Trouver le dernier
        for (let session of history) {
            const found = session.exercises.find(e => e.name === exoName || e.name.includes(exoName));
            if (found) {
                last = found;
                break; // On a trouv√© le plus r√©cent
            }
        }

        // Trouver le meilleur (Max Poids)
        let maxVal = 0;
        history.forEach(session => {
            const found = session.exercises.find(e => e.name === exoName || e.name.includes(exoName));
            if (found) {
                const val = parseFloat(found.val1.replace(',','.'));
                if (!isNaN(val) && val > maxVal) {
                    maxVal = val;
                    best = found;
                }
            }
        });

        return { last, best };
    }

    // C. TIMER & UTILS
    function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        const msg = document.getElementById("toast-msg");
        msg.innerText = message;
        toast.className = isError ? "error show" : "show";
        if(navigator.vibrate) navigator.vibrate(isError ? [50, 50, 50] : 50);
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }

    function fillInputs(index, val1, val2) {
        document.getElementById(`val1_${index}`).value = val1;
        document.getElementById(`val2_${index}`).value = val2;
        showToast("Donn√©es recopi√©es !");
    }

    let activeTimerInterval = null;
    function parseRestToSeconds(restStr) {
        if(!restStr) return 60;
        let s = 0;
        if(restStr.includes('m') && !restStr.includes('min')) {
            const parts = restStr.split('m');
            s += parseInt(parts[0]) * 60;
            if(parts[1]) s += parseInt(parts[1]);
            return s;
        }
        const match = restStr.match(/\d+/);
        if(match) return parseInt(match[0]) * 60;
        return 90;
    }

    function startTimer(btn, duration) {
        if(activeTimerInterval) clearInterval(activeTimerInterval);
        document.querySelectorAll('.timer-btn').forEach(b => {
            b.classList.remove('active');
            b.innerHTML = '<i data-lucide="timer" class="w-3 h-3"></i> ' + b.innerText.split(' ').pop();
            lucide.createIcons();
        });

        let timeLeft = duration;
        btn.classList.add('active');
        
        const updateTimer = () => {
            const min = Math.floor(timeLeft / 60);
            const sec = timeLeft % 60;
            btn.innerHTML = `<i data-lucide="hourglass" class="w-3 h-3"></i> ${min}:${sec < 10 ? '0'+sec : sec}`;
            lucide.createIcons();

            if (timeLeft <= 0) {
                clearInterval(activeTimerInterval);
                btn.classList.remove('active');
                btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> Termin√©!`;
                lucide.createIcons();
                document.getElementById('timer-sound').play().catch(() => {});
                if("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
            }
            timeLeft--;
        };
        updateTimer();
        activeTimerInterval = setInterval(updateTimer, 1000);
    }

    // --- 5. SAUVEGARDE & SYSTEME ---
    function saveWorkout(dayIndex) {
        const form = document.getElementById('workout-form');
        const dayPlan = program[dayIndex];
        const date = new Date().toLocaleDateString('fr-FR');
        
        let sessionData = {
            date: date,
            timestamp: new Date().getTime(),
            title: dayPlan.title,
            type: dayPlan.type,
            notes: form.notes ? form.notes.value : "",
            exercises: []
        };

        dayPlan.exercises.forEach((exo, index) => {
            const val1 = form[`val1_${index}`].value;
            const val2 = form[`val2_${index}`].value;
            if(val1 || val2) {
                sessionData.exercises.push({
                    name: exo.name,
                    val1: val1 || '-',
                    val2: val2 || '-'
                });
            }
        });

        if (sessionData.exercises.length === 0) {
            showToast("Rien √† valider !", true);
            return;
        }

        let history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        history.unshift(sessionData); 
        localStorage.setItem('gym_tracker_data_v2', JSON.stringify(history));

        showToast("S√©ance enregistr√©e ! üî•");
        form.reset();
        loadDailyView(dayIndex);
    }

    function toggleHistory() {
        const content = document.getElementById('app-content');
        const historyView = document.getElementById('history-view');
        
        if (historyView.classList.contains('hidden')) {
            content.classList.add('hidden');
            historyView.classList.remove('hidden');
            renderHistory();
            renderWeeklyStats();
        } else {
            content.classList.remove('hidden');
            historyView.classList.add('hidden');
        }
    }

    function renderWeeklyStats() {
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        const statsDiv = document.getElementById('weekly-stats');
        const now = new Date();
        const day = now.getDay();
        const diff = now.getDate() - day + (day == 0 ? -6 : 1); 
        const monday = new Date(now.setDate(diff)).setHours(0,0,0,0);

        let gymCount = 0;
        let runKm = 0;

        history.forEach(session => {
            const parts = session.date.split('/');
            const time = new Date(parts[2], parts[1]-1, parts[0]).getTime();
            if(time >= monday) {
                if(session.type === 'muscu') gymCount++;
                else if (session.type === 'cardio') {
                    session.exercises.forEach(ex => {
                        const km = parseFloat(ex.val1.replace(',','.'));
                        if(!isNaN(km)) runKm += km;
                    });
                }
            }
        });

        statsDiv.innerHTML = `
            <div class="bg-slate-700/50 p-3 rounded-xl border border-slate-600 text-center">
                <div class="text-xs text-slate-400 uppercase font-bold mb-1">Muscu (Hebdo)</div>
                <div class="text-2xl font-black text-white">${gymCount} <span class="text-sm text-slate-500 font-normal">s√©ances</span></div>
            </div>
            <div class="bg-slate-700/50 p-3 rounded-xl border border-slate-600 text-center">
                <div class="text-xs text-slate-400 uppercase font-bold mb-1">Running (Hebdo)</div>
                <div class="text-2xl font-black text-amber-400">${runKm.toFixed(1)} <span class="text-sm text-slate-500 font-normal">km</span></div>
            </div>`;
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        const history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
        
        if (history.length === 0) {
            list.innerHTML = '<div class="text-slate-500 text-center py-8 border border-dashed border-slate-700 rounded-xl">Aucune s√©ance. Go ! üöÄ</div>';
            return;
        }

        let html = '';
        history.forEach((session, index) => {
            const isCardio = session.type === 'cardio';
            const noteHtml = session.notes ? `<div class="text-xs text-slate-400 italic mt-3 bg-slate-900/50 p-2 rounded border-l-2 border-slate-600">"${session.notes}"</div>` : '';
            const typeColor = isCardio ? 'text-amber-400' : 'text-blue-400';
            
            html += `
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 relative group">
                    <button onclick="deleteSession(${index})" class="absolute top-4 right-4 text-slate-600 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <div class="flex items-center gap-3 mb-3 pb-3 border-b border-slate-700/50">
                        <div class="bg-slate-700/50 p-2 rounded-lg"><i data-lucide="${isCardio ? 'footprints' : 'dumbbell'}" class="w-5 h-5 ${typeColor}"></i></div>
                        <div>
                            <div class="text-white font-bold text-sm">${session.date}</div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">${session.title.split(':')[1] || session.title}</div>
                        </div>
                    </div>
                    <ul class="text-sm space-y-2">`;
            
            session.exercises.forEach(ex => {
                let display = isCardio 
                    ? `<span class="font-mono text-amber-300 font-bold">${ex.val1}km <span class="text-slate-500 font-normal">en</span> ${ex.val2}</span>`
                    : `<span class="font-mono text-white bg-slate-700 px-2 py-0.5 rounded text-xs border border-slate-600">${ex.val1}kg x ${ex.val2}</span>`;
                html += `<li class="flex justify-between items-center text-slate-300"><span class="truncate pr-4">${ex.name}</span>${display}</li>`;
            });
            html += `</ul>${noteHtml}</div>`;
        });
        list.innerHTML = html;
        lucide.createIcons();
    }

    function deleteSession(index) {
        if(confirm("Supprimer cette s√©ance ?")) {
            let history = JSON.parse(localStorage.getItem('gym_tracker_data_v2') || '[]');
            history.splice(index, 1);
            localStorage.setItem('gym_tracker_data_v2', JSON.stringify(history));
            renderHistory();
            renderWeeklyStats();
            showToast("S√©ance supprim√©e", true);
        }
    }

    function exportData() {
        const data = localStorage.getItem('gym_tracker_data_v2');
        if(!data) { showToast("Rien √† exporter", true); return; }
        const blob = new Blob([data], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `gym_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                if(Array.isArray(data)) {
                    localStorage.setItem('gym_tracker_data_v2', JSON.stringify(data));
                    showToast("Restauration r√©ussie !");
                    setTimeout(() => location.reload(), 1000);
                } else showToast("Fichier invalide", true);
            } catch(err) { showToast("Erreur fichier", true); }
        };
        reader.readAsText(file);
    }

    function clearData() {
        if(confirm("Tout effacer ?")) {
            localStorage.removeItem('gym_tracker_data_v2');
            location.reload();
        }
    }
</script>
</body>
</html>